<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïö∞ÎûåÏì∞ Î∂ÅÍ∞ÄÏù¥Îìú</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background: #F5F5F5;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 280px;
            background: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1001;
            transition: transform 0.25s ease;
        }
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.45);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.25s ease;
            z-index: 1000;
            display: none;
        }
        .sidebar-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .sidebar-header {
            background: #8B7EC8;
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.2rem;
            font-weight: 600;
        }
        .sidebar-nav {
            padding: 1rem 0;
            flex: 1;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        .nav-item:hover {
            background: #F5F5F5;
            color: #8B7EC8;
        }
        .nav-item.active {
            background: #F0EDFF;
            color: #8B7EC8;
            font-weight: 600;
        }
        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #E5E5E5;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #E6E6FA;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .profile-info {
            flex: 1;
        }
        .profile-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #333;
        }
        .profile-role {
            font-size: 0.75rem;
            color: #999;
        }
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            max-width: calc(100vw - 280px);
        }
        .top-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: center;
        }
        .menu-button {
            display: none;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 12px;
            background: #8B7EC8;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }
        .search-bar {
            flex: 1;
            position: relative;
        }
        .search-bar input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 3rem;
            border: 1px solid #E5E5E5;
            border-radius: 12px;
            font-size: 0.95rem;
            outline: none;
            background: white;
        }
        .search-bar input:focus {
            border-color: #8B7EC8;
            box-shadow: 0 0 0 3px rgba(139, 126, 200, 0.1);
        }
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        .add-book-btn {
            padding: 0.875rem 1.5rem;
            background: #FF69B4;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        .add-book-btn:hover {
            background: #FF4DA6;
        }
        .welcome-section {
            margin-bottom: 2rem;
        }
        .welcome-title {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 0.5rem;
        }
        .welcome-subtitle {
            font-size: 1rem;
            color: #666;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 0.25rem;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        .section {
            margin-bottom: 3rem;
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-subtitle {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1.5rem;
        }
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        .book-card {
            background: white;
            border-radius: 16px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .book-cover {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 0.75rem;
        }
        .book-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .book-author {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        .book-meta {
            font-size: 0.75rem;
            color: #999;
        }
        .book-heart {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1rem;
        }
        .new-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: #FF69B4;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.5rem;
            color: #FF69B4;
        }
        
        /* Ïä¨ÎùºÏù¥Îìú Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùº */
        .horizontal-scroll::-webkit-scrollbar {
            height: 8px;
        }
        .horizontal-scroll::-webkit-scrollbar-track {
            background: #f5f5f5;
            border-radius: 10px;
        }
        .horizontal-scroll::-webkit-scrollbar-thumb {
            background: #FFB6C1;
            border-radius: 10px;
        }
        .horizontal-scroll::-webkit-scrollbar-thumb:hover {
            background: #FF69B4;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .sidebar-overlay {
                display: block;
            }
            .main-content {
                margin-left: 0;
                max-width: 100vw;
                padding: 1.25rem;
            }
            .top-header {
                gap: 0.75rem;
            }
            .menu-button {
                display: inline-flex;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ‚öôÔ∏è ÏÑ§Ï†ï (API ÌÇ§Îäî ÏÑúÎ≤ÑÏóêÏÑú Í¥ÄÎ¶¨)
        const CONFIG = {
            BOOKS_TABLE: 'Books',
            READING_LOG_TABLE: 'ReadingLog'
        };

        function computeAgeMonthsFromBirthdate(birthDateString) {
            if (!birthDateString) return null;
            const parts = birthDateString.split('-');
            if (parts.length !== 3) return null;
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const day = parseInt(parts[2], 10);
            if (!year || !month || !day) return null;

            const birthDate = new Date(year, month - 1, day);
            if (Number.isNaN(birthDate.getTime())) return null;

            const today = new Date();
            let months =
                (today.getFullYear() - birthDate.getFullYear()) * 12 +
                (today.getMonth() - birthDate.getMonth());

            if (today.getDate() < birthDate.getDate()) {
                months -= 1;
            }

            if (months < 0) months = 0;
            return months;
        }

        function App() {
            const [books, setBooks] = useState([]);
            const [readingLogs, setReadingLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [currentView, setCurrentView] = useState('home'); // home, collection, theme, all, filter, settings
            const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth > 768);

            useEffect(() => {
                const handleResize = () => {
                    if (window.innerWidth > 768) {
                        setIsSidebarOpen(true);
                    } else {
                        setIsSidebarOpen(false);
                    }
                };

                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const closeSidebarIfMobile = () => {
                if (window.innerWidth <= 768) {
                    setIsSidebarOpen(false);
                }
            };

            // üîô Î∑∞ Î≥ÄÍ≤Ω Ïãú ÌûàÏä§ÌÜ†Î¶¨ Ï∂îÍ∞Ä
            const changeView = (view, data = {}) => {
                setCurrentView(view);
                if (view !== 'home') {
                    window.history.pushState({ view, ...data }, '');
                }
                if (data.theme) setSelectedTheme(data.theme);
                if (data.filterType) setFilterType(data.filterType);
            };

            // üîô ÌôàÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
            const goHome = () => {
                setCurrentView('home');
                setSelectedTheme(null);
                setFilterType(null);
                if (window.history.state?.view) {
                    window.history.back();
                }
            };

            // üîô Î∏åÎùºÏö∞Ï†Ä Îí§Î°úÍ∞ÄÍ∏∞ Ï≤òÎ¶¨
            useEffect(() => {
                const handlePopState = (event) => {
                    if (selectedBook) {
                        // Î™®Îã¨Ïù¥ Ïó¥Î†§ÏûàÏúºÎ©¥ Îã´Í∏∞
                        setSelectedBook(null);
                    } else if (currentView !== 'home') {
                        // Î∑∞Í∞Ä ÌôàÏù¥ ÏïÑÎãàÎ©¥ ÌôàÏúºÎ°ú
                        setCurrentView('home');
                        setSelectedTheme(null);
                        setFilterType(null);
                    }
                };

                window.addEventListener('popstate', handlePopState);
                return () => window.removeEventListener('popstate', handlePopState);
            }, [selectedBook, currentView]);
            const [selectedCollection, setSelectedCollection] = useState(null);
            const [selectedTheme, setSelectedTheme] = useState(null);
            const [selectedBook, setSelectedBook] = useState(null);
            const [selectedAladinBook, setSelectedAladinBook] = useState(null);


            // üìñ Ï±Ö ÏÑ†ÌÉù Ïãú ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï∂îÍ∞Ä
            const selectBook = (book) => {
                setSelectedBook(book);
                // ÌûàÏä§ÌÜ†Î¶¨Ïóê ÏÉÅÌÉú Ï∂îÍ∞Ä
                window.history.pushState({ modal: true }, '');
            };

            // üìï Ï±Ö Îã´Í∏∞
            const closeBook = () => {
                setSelectedBook(null);
                // ÌûàÏä§ÌÜ†Î¶¨ Îí§Î°úÍ∞ÄÍ∏∞ (pushStateÎ°ú Ï∂îÍ∞ÄÌïú Ìï≠Î™© Ï†úÍ±∞)
                if (window.history.state?.modal) {
                    window.history.back();
                }
            };
            const [searchTerm, setSearchTerm] = useState('');
            const [showAddForm, setShowAddForm] = useState(false);
            const [aladinNewBooks, setAladinNewBooks] = useState([]);
            const [aladinLoading, setAladinLoading] = useState(false);
            const [filterType, setFilterType] = useState(null);
            const [showSearchModal, setShowSearchModal] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchScanOpen, setSearchScanOpen] = useState(false);
            const [searchScanDecoding, setSearchScanDecoding] = useState(false);
            const [searchScanReady, setSearchScanReady] = useState(false);
            const [searchScanImage, setSearchScanImage] = useState(null);
            const [searchScanMessage, setSearchScanMessage] = useState('');
            const searchVideoRef = useRef(null);
            const searchCanvasRef = useRef(null);
            const searchStreamRef = useRef(null);
            const [searchResults, setSearchResults] = useState([]);
            const [searchLoading, setSearchLoading] = useState(false); // 'read', 'loved', 'reading'
            const [showChildProfile, setShowChildProfile] = useState(false);
            const [childProfile, setChildProfile] = useState(() => {
                // localStorageÏóêÏÑú ÏïÑÏù¥ ÌîÑÎ°úÌïÑ Î∂àÎü¨Ïò§Í∏∞
                const saved = localStorage.getItem('childProfile');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    return {
                        birthDate: parsed.birthDate || '',
                        ageMonths: parsed.ageMonths || '',
                        gender: parsed.gender || '',
                        booksPerDay: parsed.booksPerDay || 2,
                        emotionSensitivity: parsed.emotionSensitivity || 'normal'
                    };
                }
                return {
                    birthDate: '',
                    ageMonths: '',
                    gender: '',
                    booksPerDay: 2,
                    emotionSensitivity: 'normal'
                };
            });

            const computedAgeMonths = computeAgeMonthsFromBirthdate(childProfile.birthDate);
            const effectiveAgeMonths = Number.isFinite(computedAgeMonths)
                ? computedAgeMonths
                : (Number.isFinite(parseInt(childProfile.ageMonths, 10)) ? parseInt(childProfile.ageMonths, 10) : '');

            // ÏïÑÏù¥ ÌîÑÎ°úÌïÑ Ï†ÄÏû•
            const saveChildProfile = (profile) => {
                const derivedAgeMonths = computeAgeMonthsFromBirthdate(profile.birthDate);
                const normalizedProfile = {
                    ...profile,
                    ageMonths: Number.isFinite(derivedAgeMonths) ? derivedAgeMonths : (profile.ageMonths || '')
                };
                setChildProfile(normalizedProfile);
                localStorage.setItem('childProfile', JSON.stringify(normalizedProfile));
                // ÌîÑÎ°úÌïÑ Î≥ÄÍ≤Ω Ïãú Ï∂îÏ≤ú Ïû¨Î°úÎìú
                if (books.length > 0 && readingLogs.length > 0) {
                    loadTodayRecommendations(true).catch(err => console.error('Ïò§ÎäòÏùò Ï∂îÏ≤ú Ïû¨Î°úÎìú Ïã§Ìå®:', err));
                    loadAladinNewBooks(true).catch(err => console.error('ÏïåÎùºÎîò Ïã†Í∞Ñ Ïû¨Î°úÎìú Ïã§Ìå®:', err));
                }
            };

            useEffect(() => {
                loadData();
            }, []);

            useEffect(() => {
                // Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÌõÑ Ïò§ÎäòÏùò Ï∂îÏ≤ú Í∞ÄÏ†∏Ïò§Í∏∞ (10Í∂å Ï¶ùÍ∞Ä Ï≤¥ÌÅ¨Îäî loadDataÏóêÏÑú Ï≤òÎ¶¨)
                if (books.length > 0 && readingLogs.length > 0) {
                    const lastReadingCount = parseInt(localStorage.getItem('lastReadingCount') || '0');
                    const currentReadingCount = readingLogs.length;
                    const shouldForceRefresh = currentReadingCount - lastReadingCount >= 10;
                    
                    if (!shouldForceRefresh) {
                        loadTodayRecommendations().catch(err => console.error('Ïò§ÎäòÏùò Ï∂îÏ≤ú Î°úÎìú Ïã§Ìå®:', err));
                    }
                }
            }, [books, readingLogs]);

            // ÏïÑÏù¥ ÌîÑÎ°úÌïÑ Î≥ÄÍ≤Ω Ïãú Ï∂îÏ≤ú Ïû¨Î°úÎìú
            useEffect(() => {
                if (books.length > 0 && readingLogs.length > 0 && effectiveAgeMonths !== '') {
                    // ÌîÑÎ°úÌïÑÏù¥ ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÏúºÎ©¥ Ï∂îÏ≤ú Ïû¨Î°úÎìú
                    loadTodayRecommendations(true).catch(err => console.error('Ïò§ÎäòÏùò Ï∂îÏ≤ú Ïû¨Î°úÎìú Ïã§Ìå®:', err));
                    loadAladinNewBooks(true).catch(err => console.error('ÏïåÎùºÎîò Ïã†Í∞Ñ Ïû¨Î°úÎìú Ïã§Ìå®:', err));
                }
            }, [effectiveAgeMonths, childProfile.emotionSensitivity]);

            async function loadData() {
                try {
                    const [booksData, logsData] = await Promise.all([
                        fetchAirtable(CONFIG.BOOKS_TABLE),
                        fetchAirtable(CONFIG.READING_LOG_TABLE)
                    ]);
                    setBooks(booksData);
                    setReadingLogs(logsData);
                    
                    // ÏùΩÍ∏∞ Í∏∞Î°ù Ïàò ÎπÑÍµê (10Í∂å Ïù¥ÏÉÅ Ï¶ùÍ∞ÄÌñàÏúºÎ©¥ Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®)
                    const lastReadingCount = parseInt(localStorage.getItem('lastReadingCount') || '0');
                    const currentReadingCount = logsData.length;
                    const shouldForceRefresh = currentReadingCount - lastReadingCount >= 10;
                    
                    if (shouldForceRefresh) {
                        console.log(`üìö ÏùΩÍ∏∞ Í∏∞Î°ùÏù¥ ${currentReadingCount - lastReadingCount}Í∂å Ï¶ùÍ∞ÄÌñàÏäµÎãàÎã§. Ï∂îÏ≤úÏùÑ ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.`);
                        localStorage.setItem('lastReadingCount', currentReadingCount.toString());
                        // Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®
                        loadAladinNewBooks(true).catch(err => console.error('ÏïåÎùºÎîò Ïã†Í∞Ñ Ïû¨Î°úÎìú Ïã§Ìå®:', err));
                        loadTodayRecommendations(true).catch(err => console.error('Ïò§ÎäòÏùò Ï∂îÏ≤ú Ïû¨Î°úÎìú Ïã§Ìå®:', err));
                    } else {
                        // ÏùºÎ∞ò Î°úÎìú
                        loadAladinNewBooks().catch(err => console.error('ÏïåÎùºÎîò Ïã†Í∞Ñ Î°úÎìú Ïã§Ìå®:', err));
                        // ÎßàÏßÄÎßâ ÏùΩÍ∏∞ Í∏∞Î°ù Ïàò ÏóÖÎç∞Ïù¥Ìä∏
                        localStorage.setItem('lastReadingCount', currentReadingCount.toString());
                    }
                } catch (error) {
                    console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                } finally {
                    setLoading(false);
                }
            }

            // üìö ÏïåÎùºÎîò Ïã†Í∞Ñ Ï∂îÏ≤ú (4~7ÏÑ∏, Ï∫êÎ¶≠ÌÑ∞ Ï†úÏô∏) - Ìïú Îã¨Ïóê Ìïú Î≤àÎßå Î°úÎìú
            async function loadAladinNewBooks(forceRefresh = false) {
                const today = new Date();
                const monthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`; // YYYY-MM
                
                // Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®Ïù¥ ÏïÑÎãàÎ©¥ Ï∫êÏãú ÌôïÏù∏
                if (!forceRefresh) {
                    try {
                        const cached = localStorage.getItem('aladinNewBooks');
                        if (cached) {
                            const { date, books } = JSON.parse(cached);
                            if (date === monthKey && books.length > 0) {
                                console.log('üìò ÏïåÎùºÎîò Ïã†Í∞Ñ Ï∫êÏãú ÏÇ¨Ïö©:', books.length, 'Í∂å');
                                setAladinNewBooks(books);
                                return books;
                            }
                        }
                    } catch (e) {
                        console.error('Ï∫êÏãú Î°úÎìú Ïã§Ìå®:', e);
                    }
                } else {
                    localStorage.removeItem('aladinNewBooks');
                }
                
                // ÏÉàÎ°ú Î°úÎìú
                setAladinLoading(true);
                console.log('üìò ÏïåÎùºÎîò Ïã†Í∞Ñ API Ìò∏Ï∂ú...');
                
                try {
                    // ÏïÑÏù¥ ÌîÑÎ°úÌïÑÏùÑ ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞Î°ú Ï†ÑÎã¨
                    const profileParams = new URLSearchParams();
                    if (effectiveAgeMonths !== '') profileParams.append('ageMonths', effectiveAgeMonths);
                    if (childProfile.gender) profileParams.append('gender', childProfile.gender);
                    if (childProfile.booksPerDay) profileParams.append('booksPerDay', childProfile.booksPerDay);
                    if (childProfile.emotionSensitivity) profileParams.append('emotionSensitivity', childProfile.emotionSensitivity);
                    
                    if (forceRefresh) {
                        profileParams.append('force', '1');
                        profileParams.append('ts', Date.now().toString());
                    }
                    
                    const url = `/api/aladin-new-books${profileParams.toString() ? '?' + profileParams.toString() : ''}`;
                    const response = await fetch(url, { cache: 'no-store' });
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('üìò API Ìò∏Ï∂ú Ïã§Ìå®:', response.status, errorText);
                        throw new Error('API Ìò∏Ï∂ú Ïã§Ìå®: ' + response.status);
                    }
                    const data = await response.json();
                    
                    // ÎîîÎ≤ÑÍπÖ Ï†ïÎ≥¥ Ï∂úÎ†•
                    if (data.debug) {
                        console.log('üìò ÎîîÎ≤ÑÍπÖ Ï†ïÎ≥¥:', data.debug);
                    }
                    
                    // Î∞±ÏóîÎìúÍ∞Ä Î∞òÌôòÌïòÎäî ÌòïÏãù: { success: true, total: number, books: [...] }
                    if (data.success && data.books && data.books.length > 0) {
                        console.log('üìò Ïã†Í∞Ñ:', data.books.length, 'Í∂å', data.books);
                        
                        // Ï≤´ Î≤àÏß∏ Ï±ÖÏùò recommendationReason ÌôïÏù∏
                        if (data.books[0]) {
                            console.log('üìò Ï≤´ Î≤àÏß∏ Ï±Ö Ï∂îÏ≤ú Ïù¥Ïú†:', data.books[0].recommendationReason);
                        }
                        
                        // ÌïÑÌÑ∞ÎßÅ: Ï∫êÎ¶≠ÌÑ∞/ÌïôÏäµ Ï†úÏô∏ (Î∞±ÏóîÎìúÏóêÏÑú Ïù¥ÎØ∏ ÌïÑÌÑ∞ÎßÅÎêòÏóàÏßÄÎßå Ï∂îÍ∞Ä ÌïÑÌÑ∞ÎßÅ)
                        const excludeKeywords = ['ÎΩÄÎ°úÎ°ú', 'ÌïëÌÅ¨ÌêÅ', 'ÌÉÄÏöî', 'Ìè¨ÏºìÎ™¨', 'ÎîîÏ¶àÎãà', 'ÌïôÏäµ', 'ÏõåÌÅ¨Î∂Å', 'Î¨∏Ï†úÏßë', 'Ïä§Ìã∞Ïª§', 'ÏÑ∏Ìä∏', 'Ï†ÑÏßë'];
                        
                        const filtered = data.books.filter(book => {
                            const title = (book.title || '').toLowerCase();
                            const desc = (book.description || '').toLowerCase();
                            const combined = (title + ' ' + desc);
                            
                            const hasExcluded = excludeKeywords.some(keyword => 
                                combined.includes(keyword.toLowerCase())
                            );
                            
                            return !hasExcluded;
                        });
                        
                        console.log('üìò ÌïÑÌÑ∞ÎßÅ ÌõÑ:', filtered.length, 'Í∂å');
                        if (filtered[0]) {
                            console.log('üìò ÌïÑÌÑ∞ÎßÅ ÌõÑ Ï≤´ Î≤àÏß∏ Ï±Ö:', filtered[0].title, 'Ï∂îÏ≤ú Ïù¥Ïú†:', filtered[0].recommendationReason);
                        }
                        
                        // localStorageÏóê Ï†ÄÏû• (ÏõîÎ≥Ñ ÌÇ§ ÏÇ¨Ïö©)
                        try {
                            const today = new Date();
                            const monthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                            localStorage.setItem('aladinNewBooks', JSON.stringify({
                                date: monthKey,
                                books: filtered
                            }));
                            console.log('üìò ÏïåÎùºÎîò Ïã†Í∞Ñ Ï∫êÏãú Ï†ÄÏû•:', filtered.length, 'Í∂å');
                        } catch (e) {
                            console.error('Ï∫êÏãú Ï†ÄÏû• Ïã§Ìå®:', e);
                        }
                        
                        setAladinNewBooks(filtered);
                        return filtered;
                    } else {
                        console.log('üìò ÏïåÎùºÎîò Ïã†Í∞Ñ ÏóÜÏùå', data);
                        // Ïã†Í∞ÑÏù¥ ÏóÜÏñ¥ÎèÑ Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Îäî Ïú†ÏßÄ (Îπà Î∞∞Ïó¥Î°ú ÏÑ§Ï†ïÌïòÏßÄ ÏïäÏùå)
                        if (aladinNewBooks.length === 0) {
                            setAladinNewBooks([]);
                        }
                        return [];
                    }
                } catch (error) {
                    console.error('üìò ÏïåÎùºÎîò Ïã†Í∞Ñ API Ïò§Î•ò:', error);
                    // ÏóêÎü¨ Î∞úÏÉù ÏãúÏóêÎèÑ Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ
                    if (aladinNewBooks.length === 0) {
                        setAladinNewBooks([]);
                    }
                    return [];
                } finally {
                    setAladinLoading(false);
                }
            }

            const stopSearchCamera = () => {
                if (searchStreamRef.current) {
                    searchStreamRef.current.getTracks().forEach((track) => track.stop());
                    searchStreamRef.current = null;
                }
                if (searchVideoRef.current) {
                    searchVideoRef.current.srcObject = null;
                }
                setSearchScanReady(false);
            };

            const startSearchCamera = () => {
                setSearchScanReady(false);
                setSearchScanDecoding(false);
                setSearchScanImage(null);
                setSearchScanMessage('');

                navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { ideal: "environment" } },
                    audio: false
                }).then((stream) => {
                    searchStreamRef.current = stream;
                    if (searchVideoRef.current) {
                        searchVideoRef.current.srcObject = stream;
                        searchVideoRef.current.play();
                    }
                }).catch((error) => {
                    console.error('Ïπ¥Î©îÎùº Ï†ëÍ∑º Ïò§Î•ò:', error);
                    alert('Ïπ¥Î©îÎùº Ï†ëÍ∑º Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú Ïπ¥Î©îÎùº Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.');
                    setSearchScanOpen(false);
                });
            };

            const handleSearchScanStart = () => {
                if (!window.Quagga) {
                    alert('Î∞îÏΩîÎìú Ïä§Ï∫êÎÑà ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                setSearchScanOpen(true);
                startSearchCamera();
            };

            const handleSearchCapture = () => {
                if (!searchVideoRef.current || !searchCanvasRef.current) {
                    return;
                }

                const video = searchVideoRef.current;
                const canvas = searchCanvasRef.current;
                if (!video.videoWidth || !video.videoHeight) {
                    alert('Ïπ¥Î©îÎùº Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                const width = video.videoWidth;
                const height = video.videoHeight;
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, width, height);

                const dataUrl = canvas.toDataURL('image/png');
                setSearchScanImage(dataUrl);
                setSearchScanMessage('');
                stopSearchCamera();
                setSearchScanDecoding(true);

                const tryDecode = (size) => new Promise((resolve) => {
                    Quagga.decodeSingle({
                        src: dataUrl,
                        numOfWorkers: 0,
                        inputStream: { size, singleChannel: false },
                        locator: { patchSize: "medium", halfSample: true },
                        decoder: {
                            readers: [
                                "ean_reader",
                                "ean_8_reader",
                                "upc_reader",
                                "upc_e_reader",
                                "code_128_reader"
                            ]
                        },
                        locate: true
                    }, (result) => resolve(result));
                });

                const attempt = async () => {
                    const sizes = [2000, 1600, 1200, 800];
                    for (const size of sizes) {
                        const result = await tryDecode(size);
                        if (result && result.codeResult && result.codeResult.code) {
                            return result.codeResult.code;
                        }
                    }
                    return null;
                };

                attempt().then((code) => {
                    setSearchScanDecoding(false);
                    if (code) {
                        const isbn = code.replace(/[^0-9X]/g, '');
                        if (isbn.length === 10 || isbn.length === 13) {
                            setSearchQuery(isbn);
                            searchAladinBooks(isbn, true);
                            setSearchScanOpen(false);
                            return;
                        }
                        setSearchScanMessage('Ïò¨Î∞îÎ•∏ ISBN Î∞îÏΩîÎìúÎ•º Ïù∏ÏãùÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§. Îã§Ïãú Ï∞çÏñ¥Ï£ºÏÑ∏Ïöî.');
                    } else {
                        setSearchScanMessage('Ïù∏Ïãù Ïã§Ìå®: Îçî Í∞ÄÍπåÏù¥/Î∞ùÏùÄ Í≥≥ÏóêÏÑú Îã§Ïãú Ï∞çÏñ¥Ï£ºÏÑ∏Ïöî.');
                    }
                });
            };

            const handleSearchScanRetry = () => {
                setSearchScanImage(null);
                setSearchScanMessage('');
                startSearchCamera();
            };

            // üìö ÏïåÎùºÎîò Ï±Ö Í≤ÄÏÉâ
            async function searchAladinBooks(query, isIsbn = false) {
                if (!query.trim()) return;
                
                setSearchLoading(true);
                try {
                    const response = await fetch(`/api/aladin-search?query=${encodeURIComponent(query)}${isIsbn ? '&isbn=true' : ''}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        setSearchResults(data.books || []);
                    } else {
                        alert('Í≤ÄÏÉâ Ïã§Ìå®: ' + data.error);
                    }
                } catch (error) {
                    console.error('Í≤ÄÏÉâ Ïò§Î•ò:', error);
                    alert('Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
                } finally {
                    setSearchLoading(false);
                }
            }

            // üìñ Í¥ÄÏã¨ ÏûàÎäî Ï±Ö Ï∂îÍ∞Ä (AirtableÏóê Ï†ÄÏû•)
            async function addInterestedBook(book) {
                try {
                    // AirtableÏóêÏÑú Ï±Ö Ï∞æÍ∏∞ (ISBN ÎòêÎäî Ï†úÎ™©ÏúºÎ°ú)
                    const booksData = await fetchAirtable(CONFIG.BOOKS_TABLE);
                    const existingBook = booksData.find(b => 
                        (b.fields['ISBN'] && book.isbn && b.fields['ISBN'] === book.isbn) ||
                        (b.fields['Ï†úÎ™©'] && book.title && b.fields['Ï†úÎ™©'] === book.title)
                    );
                    
                    if (existingBook) {
                        // Ïù¥ÎØ∏ ÏûàÎäî Ï±ÖÏù¥Î©¥ Í¥ÄÏã¨ ÌïÑÎìúÎßå ÏóÖÎç∞Ïù¥Ìä∏
                        const response = await fetch('/api/update-book-field', {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                recordId: existingBook.id,
                                fields: {
                                    'Í¥ÄÏã¨': true
                                }
                            })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            alert('Í¥ÄÏã¨Ï±ÖÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!');
                            await loadData();
                        } else {
                            alert('Ïò§Î•ò: ' + (data.error || 'Ï†ÄÏû• Ïã§Ìå®'));
                        }
                    } else {
                        // Ï±ÖÏù¥ ÏóÜÏúºÎ©¥ Ï°∞Ïö©Ìûà Î¨¥Ïãú (ÌåùÏóÖ ÏóÜÏùå)
                    }
                } catch (error) {
                    console.error('Í¥ÄÏã¨Ï±Ö Ï∂îÍ∞Ä Ïò§Î•ò:', error);
                    alert('Í¥ÄÏã¨Ï±Ö Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
                }
            }

            async function fetchAirtable(tableName) {
                // SupabaseÎ°ú ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖòÎê® - ÌïòÏúÑ Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌï¥ Ìï®ÏàòÎ™Ö Ïú†ÏßÄ
                const response = await fetch(`/api/supabase?table=${tableName}`);
                if (!response.ok) {
                    throw new Error('Supabase fetch failed');
                }
                return await response.json();
            }

            async function updateReadingLog(bookId, logData) {
                try {
                    const existingLog = readingLogs.find(log => log.fields['Ï±Ö']?.[0] === bookId);

                    const response = await fetch('/api/reading-log', {
                        method: existingLog ? 'PATCH' : 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            bookId,
                            logData,
                            recordId: existingLog?.id
                        })
                    });

                    if (response.ok) {
                        console.log('‚úÖ Î°úÍ∑∏ Ï†ÄÏû• ÏÑ±Í≥µ');
                        await loadData(); // ÏÉàÎ°úÍ≥†Ïπ®
                        // ÏùΩÍ∏∞ Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Ï∂îÏ≤ú Ïû¨Î°úÎìú
                        setTimeout(() => {
                            loadTodayRecommendations(true).catch(err => console.error('Ïò§ÎäòÏùò Ï∂îÏ≤ú Ïû¨Î°úÎìú Ïã§Ìå®:', err));
                            loadAladinNewBooks(true).catch(err => console.error('ÏïåÎùºÎîò Ïã†Í∞Ñ Ïû¨Î°úÎìú Ïã§Ìå®:', err));
                        }, 500);
                        return true;
                    } else {
                        const error = await response.json();
                        console.error('‚ùå Ïò§Î•ò:', error);
                        alert('Ïò§Î•ò: ' + (error.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                        return false;
                    }
                } catch (error) {
                    console.error('‚ùå Î°úÍ∑∏ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', error);
                    alert('Ïò§Î•ò: ' + error.message);
                    return false;
                }
            }

            // üìä ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
            const stats = {
                total: books.length,
                read: readingLogs.length,
                loved: readingLogs.filter(log => log.fields['ÏïÑÏù¥Î∞òÏùë'] === 'üòç').length,
                interested: books.filter(b => b.fields['Í¥ÄÏã¨'] === true || b.fields['Í¥ÄÏã¨'] === 'true').length
            };

            // üéØ Ïò§ÎäòÏùò Ï∂îÏ≤ú (Ï†êÏàò Í∏∞Î∞ò ÏïåÍ≥†Î¶¨Ï¶ò)
            const getTodayRecommendations = (booksData, logsData) => {
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                
                // ÏùΩÏßÄ ÏïäÏùÄ Ï±Ö
                const unreadBooks = booksData.filter(book => 
                    !logsData.find(log => log.fields['Ï±Ö']?.[0] === book.id)
                );
                
                if (unreadBooks.length === 0) return null;
                
                // üòç ÏµúÏï† Ï±ÖÎì§Ïùò ÌÖåÎßà ÏàòÏßë
                const lovedBooks = logsData
                    .filter(log => log.fields['ÏïÑÏù¥Î∞òÏùë'] === 'üòç')
                    .map(log => booksData.find(b => b.id === log.fields['Ï±Ö']?.[0]))
                    .filter(Boolean);
                
                const lovedThemes = lovedBooks
                    .map(b => b.fields['ÌÖåÎßà'])
                    .filter(Boolean)
                    .join(',')
                    .split(',')
                    .map(t => t.trim().toLowerCase())
                    .filter(Boolean);
                
                // ÏµúÍ∑º ÏùΩÏùÄ Ï±ÖÎì§Ïùò ÌÖåÎßà
                const recentBooks = logsData
                    .slice(-10) // ÏµúÍ∑º 10Í∂å
                    .map(log => booksData.find(b => b.id === log.fields['Ï±Ö']?.[0]))
                    .filter(Boolean);
                
                const recentThemes = recentBooks
                    .map(b => b.fields['ÌÖåÎßà'])
                    .filter(Boolean)
                    .join(',')
                    .split(',')
                    .map(t => t.trim().toLowerCase())
                    .filter(Boolean);
                
                // Ïö∞ÎûåÏù¥ Ïó∞Î†π Ï∂îÏ†ï (ÏùΩÏùÄ Ï±ÖÎì§ Í∏∞Ï§Ä)
                const readBooksWithAge = logsData
                    .map(log => booksData.find(b => b.id === log.fields['Ï±Ö']?.[0]))
                    .filter(b => b && b.fields['Ïó∞Î†π']);
                
                let targetMinAge = 4, targetMaxAge = 7;
                if (readBooksWithAge.length > 0) {
                    const ageRanges = readBooksWithAge
                        .map(b => {
                            const match = b.fields['Ïó∞Î†π'].match(/(\d+)[-~](\d+)/);
                            if (match) return { min: parseInt(match[1]), max: parseInt(match[2]) };
                            const single = b.fields['Ïó∞Î†π'].match(/(\d+)/);
                            if (single) return { min: parseInt(single[1]), max: parseInt(single[1]) };
                            return null;
                        })
                        .filter(Boolean);
                    
                    if (ageRanges.length > 0) {
                        targetMinAge = Math.round(ageRanges.reduce((sum, r) => sum + r.min, 0) / ageRanges.length);
                        targetMaxAge = Math.round(ageRanges.reduce((sum, r) => sum + r.max, 0) / ageRanges.length);
                    }
                }
                
                // Í∞Å Ï±ÖÏóê Ï†êÏàò Í≥ÑÏÇ∞ (Ï¥ù 100Ï†ê)
                const scoredBooks = unreadBooks.map(book => {
                    let score = 0;
                    
                    // 1. ÌÖåÎßà Ï†êÏàò (50Ï†ê) - Ïö∞ÏÑ†ÏàúÏúÑ Í∞ïÌôî
                    const bookThemes = (book.fields['ÌÖåÎßà'] || '')
                        .split(',')
                        .map(t => t.trim().toLowerCase())
                        .filter(Boolean);
                    
                    let lovedMatches = 0;
                    let recentMatches = 0;
                    
                    bookThemes.forEach(theme => {
                        if (lovedThemes.includes(theme)) lovedMatches++;
                        if (recentThemes.includes(theme)) recentMatches++;
                    });
                    
                    if (lovedMatches >= 2) score += 50;
                    else if (lovedMatches === 1) score += 30;
                    else if (recentMatches > 0) score += 15;
                    
                    // 2. Ïó∞Î†π Ï†êÏàò (30Ï†ê)
                    const ageField = book.fields['Ïó∞Î†π'] || '';
                    const ageMatch = ageField.match(/(\d+)[-~](\d+)/);
                    
                    if (ageMatch) {
                        const bookMinAge = parseInt(ageMatch[1]);
                        const bookMaxAge = parseInt(ageMatch[2]);
                        
                        // Ï†ïÌôïÌûà ÏùºÏπò
                        if (bookMinAge === targetMinAge && bookMaxAge === targetMaxAge) {
                            score += 30;
                        }
                        // Î≤îÏúÑ ÎÇ¥
                        else if (bookMinAge <= targetMaxAge && bookMaxAge >= targetMinAge) {
                            score += 20;
                        }
                    } else {
                        const singleAge = ageField.match(/(\d+)/);
                        if (singleAge) {
                            const age = parseInt(singleAge[1]);
                            if (age >= targetMinAge && age <= targetMaxAge) {
                                score += 25;
                            }
                        }
                    }
                    
                    // 3. Îã§ÏñëÏÑ± Ï†êÏàò (20Ï†ê)
                    const publisher = book.fields['Ï∂úÌåêÏÇ¨'] || '';
                    const collection = book.fields['Ï†ÑÏßëÎ™Ö'] || '';
                    
                    const recentPublishers = recentBooks.map(b => b.fields['Ï∂úÌåêÏÇ¨']).filter(Boolean);
                    const recentCollections = recentBooks.map(b => b.fields['Ï†ÑÏßëÎ™Ö']).filter(Boolean);
                    
                    if (!recentPublishers.includes(publisher) || !publisher) score += 10;
                    if (!recentCollections.includes(collection) || !collection) score += 10;
                    
                    return { book, score, lovedMatches, recentMatches };
                });
                
                // Ï†êÏàò ÏàúÏúºÎ°ú Ï†ïÎ†¨
                scoredBooks.sort((a, b) => b.score - a.score);
                
                // Í∞ôÏùÄ Ï†êÏàòÎ©¥ ÎÇ†Ïßú ÏãúÎìúÎ°ú ÏÑûÍ∏∞
                const seed = today.split('-').reduce((a, b) => parseInt(a) + parseInt(b), 0);
                let randomSeed = seed;
                const seededRandom = () => {
                    randomSeed = (randomSeed * 9301 + 49297) % 233280;
                    return randomSeed / 233280;
                };
                
                const grouped = {};
                scoredBooks.forEach(item => {
                    if (!grouped[item.score]) grouped[item.score] = [];
                    grouped[item.score].push(item);
                });
                
                Object.keys(grouped).forEach(score => {
                    const group = grouped[score];
                    for (let i = group.length - 1; i > 0; i--) {
                        const j = Math.floor(seededRandom() * (i + 1));
                        [group[i], group[j]] = [group[j], group[i]];
                    }
                });
                
                const finalList = Object.keys(grouped)
                    .sort((a, b) => b - a)
                    .flatMap(score => grouped[score]);
                
                return {
                    recommendations: finalList.slice(0, 10),
                    userProfile: {
                        lovedThemes: [...new Set(lovedThemes)],
                        recentThemes: [...new Set(recentThemes)],
                        ageRange: `${targetMinAge}-${targetMaxAge}ÏÑ∏`
                    }
                };
            };

            // üìö Ï±ïÌÑ∞Î∂Å Ï†ÑÌôò Í∞êÏßÄ
            const detectChapterBookReadiness = (booksData, logsData) => {
                if (logsData.length < 10) return null; // ÏµúÏÜå 10Í∂å ÌïÑÏöî
                
                // ÏµúÍ∑º 10Í∂å Î∂ÑÏÑù
                const recentBooks = logsData
                    .slice(-10)
                    .map(log => booksData.find(b => b.id === log.fields['Ï±Ö']?.[0]))
                    .filter(Boolean);
                
                // Ï°∞Í±¥ 1: Í∏¥ Ïù¥ÏïºÍ∏∞ ÏÑ†Ìò∏ (Í∏ÄÎ∞•Ïù¥ ÎßéÏùÄ Ï±Ö)
                const longStoryBooks = recentBooks.filter(b => {
                    const themes = (b.fields['ÌÖåÎßà'] || '').toLowerCase();
                    return themes.includes('Ïù¥ÏïºÍ∏∞') || themes.includes('ÏÉÅÏÉÅ');
                }).length;
                
                // Ï°∞Í±¥ 2: 5-7ÏÑ∏ Ïó∞Î†πÎåÄ
                const ageAppropriate = recentBooks.filter(b => {
                    const age = b.fields['Ïó∞Î†π'] || '';
                    return age.match(/[5-7]/);
                }).length;
                
                // Ï°∞Í±¥ 3: üòç Î∞òÏùëÏù¥ ÎßéÏùå (ÎèÖÏÑú Ï¶êÍ±∞ÏõÄ)
                const lovedCount = logsData
                    .slice(-10)
                    .filter(log => log.fields['ÏïÑÏù¥Î∞òÏùë'] === 'üòç').length;
                
                const signals = {
                    longStory: longStoryBooks >= 5,
                    ageReady: ageAppropriate >= 7,
                    enjoysReading: lovedCount >= 4
                };
                
                const readyCount = Object.values(signals).filter(Boolean).length;
                
                if (readyCount >= 2) {
                    return {
                        level: readyCount === 3 ? 'STRONG' : 'MEDIUM',
                        signals
                    };
                }
                
                return null;
            };

            // üéØ Ïò§ÎäòÏùò Ï∂îÏ≤ú (APIÎ°ú Í∞ÄÏ†∏Ïò§Í∏∞)
            const [recommendations, setRecommendations] = useState([]);
            const [recommendationsLoading, setRecommendationsLoading] = useState(false);

            async function loadTodayRecommendations(forceRefresh = false) {
                const today = new Date().toISOString().split('T')[0];
                
                // Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®Ïù¥ ÏïÑÎãàÎ©¥ Ï∫êÏãú ÌôïÏù∏
                if (!forceRefresh) {
                    try {
                        const cached = localStorage.getItem('todayRecommendations');
                        if (cached) {
                            const { date, books } = JSON.parse(cached);
                            if (date === today && books.length > 0) {
                                console.log('üéØ Ïò§ÎäòÏùò Ï∂îÏ≤ú Ï∫êÏãú ÏÇ¨Ïö©:', books.length, 'Í∂å');
                                setRecommendations(books);
                                return books;
                            }
                        }
                    } catch (e) {
                        console.error('Ï∫êÏãú Î°úÎìú Ïã§Ìå®:', e);
                    }
                } else {
                    localStorage.removeItem('todayRecommendations');
                }
                
                setRecommendationsLoading(true);
                console.log('üéØ Ïò§ÎäòÏùò Ï∂îÏ≤ú API Ìò∏Ï∂ú...');
                
                try {
                    // ÏïÑÏù¥ ÌîÑÎ°úÌïÑÏùÑ ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞Î°ú Ï†ÑÎã¨
                    const profileParams = new URLSearchParams();
                    if (effectiveAgeMonths !== '') profileParams.append('ageMonths', effectiveAgeMonths);
                    if (childProfile.gender) profileParams.append('gender', childProfile.gender);
                    if (childProfile.booksPerDay) profileParams.append('booksPerDay', childProfile.booksPerDay);
                    if (childProfile.emotionSensitivity) profileParams.append('emotionSensitivity', childProfile.emotionSensitivity);
                    
                    if (forceRefresh) {
                        profileParams.append('force', '1');
                        profileParams.append('ts', Date.now().toString());
                    }
                    
                    const url = `/api/today-recommendations${profileParams.toString() ? '?' + profileParams.toString() : ''}`;
                    const response = await fetch(url, { cache: 'no-store' });
                    
                    if (!response.ok) {
                        throw new Error('API Ìò∏Ï∂ú Ïã§Ìå®: ' + response.status);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.books && data.books.length > 0) {
                        console.log('üéØ Ïò§ÎäòÏùò Ï∂îÏ≤ú:', data.books.length, 'Í∂å');
                        
                        // Airtable Ï±Ö Îç∞Ïù¥ÌÑ∞ÏôÄ Îß§Ïπ≠
                        const matchedBooks = data.books.map(apiBook => {
                            const book = books.find(b => b.id === apiBook.id);
                            return book ? { book, score: apiBook.score, recommendationReason: apiBook.recommendationReason } : null;
                        }).filter(Boolean);
                        
                        // localStorageÏóê Ï†ÄÏû•
                        try {
                            localStorage.setItem('todayRecommendations', JSON.stringify({
                                date: today,
                                books: matchedBooks
                            }));
                            console.log('üéØ Ïò§ÎäòÏùò Ï∂îÏ≤ú Ï∫êÏãú Ï†ÄÏû•:', matchedBooks.length, 'Í∂å');
                        } catch (e) {
                            console.error('Ï∫êÏãú Ï†ÄÏû• Ïã§Ìå®:', e);
                        }
                        
                        setRecommendations(matchedBooks);
                        return matchedBooks;
                    } else {
                        console.log('üéØ Ïò§ÎäòÏùò Ï∂îÏ≤ú ÏóÜÏùå', data);
                        setRecommendations([]);
                        return [];
                    }
                } catch (error) {
                    console.error('üéØ Ïò§ÎäòÏùò Ï∂îÏ≤ú API Ïò§Î•ò:', error);
                    // ÏóêÎü¨ Ïãú Í∏∞Ï°¥ Î°úÏßÅÏúºÎ°ú fallback
                    const todayResult = books.length > 0 && readingLogs.length > 0 
                        ? getTodayRecommendations(books, readingLogs) 
                        : null;
                    const fallbackRecs = todayResult?.recommendations || [];
                    setRecommendations(fallbackRecs.map(item => ({ ...item, recommendationReason: null })));
                    return fallbackRecs;
                } finally {
                    setRecommendationsLoading(false);
                }
            }

            // üìö Ï±ïÌÑ∞Î∂Å Ï†ÑÌôò Í∞êÏßÄ
            const [chapterBookReadiness, setChapterBookReadiness] = useState(null);
            
            useEffect(() => {
                if (books.length > 0 && readingLogs.length > 0) {
                    const readiness = detectChapterBookReadiness(books, readingLogs);
                    setChapterBookReadiness(readiness);
                }
            }, [books, readingLogs]);

            // üìñ ÏùΩÍ≥† ÏûàÎäî Ï±Ö (Ï†úÍ±∞ - ÏùòÎèÑÎêú Í∏∞Îä•Ïù¥ ÏïÑÎãò)
            // const currentlyReading = readingLogs
            //     .filter(log => !log.fields['ÏôÑÎèÖÏó¨Î∂Ä'])
            //     .map(log => books.find(book => book.id === log.fields['Ï±Ö']?.[0]))
            //     .filter(Boolean);

            // üìö Ï†ÑÏßë Î™©Î°ù
            const collections = [...new Set(books.map(b => b.fields['Ï†ÑÏßëÎ™Ö']).filter(Boolean))]
                .map(name => ({
                    name,
                    count: books.filter(b => b.fields['Ï†ÑÏßëÎ™Ö'] === name).length
                }))
                .sort((a, b) => b.count - a.count);

            // üè∑Ô∏è Ïù∏Í∏∞ ÌÖåÎßà
            const allThemes = books
                .map(b => b.fields['ÌÖåÎßà'])
                .filter(Boolean)
                .join(',')
                .split(',')
                .map(t => t.trim())
                .filter(Boolean);
            
            const themeCount = {};
            allThemes.forEach(theme => {
                themeCount[theme] = (themeCount[theme] || 0) + 1;
            });
            
            const popularThemes = Object.entries(themeCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([theme]) => theme);

            if (loading) {
                return <div className="loading">üìö ÎèÑÏÑú Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>;
            }

            return (
                <div className="app-container">
                    <div
                        className={`sidebar-overlay ${isSidebarOpen ? 'open' : ''}`}
                        onClick={() => setIsSidebarOpen(false)}
                    ></div>
                    {/* ÏÇ¨Ïù¥ÎìúÎ∞î */}
                    <div className={`sidebar ${isSidebarOpen ? 'open' : ''}`}>
                        <div className="sidebar-header">
                            <span>üè†</span>
                            <span>ÎåÄÏãúÎ≥¥Îìú</span>
                        </div>
                        <div className="sidebar-nav">
                            <div 
                                className={`nav-item ${currentView === 'home' ? 'active' : ''}`}
                                onClick={() => {
                                    goHome();
                                    setSearchTerm('');
                                    closeSidebarIfMobile();
                                }}
                            >
                                <span>üè†</span>
                                <span>ÎåÄÏãúÎ≥¥Îìú</span>
                            </div>
                            <div 
                                className={`nav-item ${currentView === 'all' ? 'active' : ''}`}
                                onClick={() => {
                                    changeView('all');
                                    closeSidebarIfMobile();
                                }}
                            >
                                <span>üìö</span>
                                <span>Ï†ÑÏ≤¥ Ï±Ö</span>
                            </div>
                            <div 
                                className={`nav-item ${currentView === 'filter' && filterType === 'read' ? 'active' : ''}`}
                                onClick={() => {
                                    changeView('filter', { filterType: 'read' });
                                    closeSidebarIfMobile();
                                }}
                            >
                                <span>üìñ</span>
                                <span>ÏùΩÏùÄ Ï±Ö</span>
                            </div>
                            <div 
                                className={`nav-item ${currentView === 'filter' && filterType === 'interested' ? 'active' : ''}`}
                                onClick={() => {
                                    changeView('filter', { filterType: 'interested' });
                                    closeSidebarIfMobile();
                                }}
                            >
                                <span>‚ù§Ô∏è</span>
                                <span>Í¥ÄÏã¨Ï±Ö</span>
                            </div>
                            <div 
                                className={`nav-item ${currentView === 'settings' ? 'active' : ''}`}
                                onClick={() => {
                                    changeView('settings');
                                    closeSidebarIfMobile();
                                }}
                            >
                                <span>‚öôÔ∏è</span>
                                <span>ÏÑ§Ï†ï</span>
                            </div>
                        </div>
                        <div className="sidebar-footer">
                            <div className="profile-avatar">üë§</div>
                            <div className="profile-info">
                                <div className="profile-name">Ïö∞ÎûåÏù¥</div>
                                <div className="profile-role">Î∂ÄÎ™® Í≥ÑÏ†ï</div>
                            </div>
                        </div>
                    </div>

                    {/* Î©îÏù∏ ÏΩòÌÖêÏ∏† */}
                    <div className="main-content">
                        {/* ÏÉÅÎã® Ìó§Îçî - ÌôàÏóêÏÑúÎßå Í≤ÄÏÉâ/Ï±Ö Ï∂îÍ∞Ä ÌëúÏãú */}
                        <div className="top-header">
                            <button
                                className="menu-button"
                                onClick={() => setIsSidebarOpen(true)}
                                aria-label="ÏÇ¨Ïù¥ÎìúÎ∞î Ïó¥Í∏∞"
                            >
                                ‚ò∞
                            </button>
                            {currentView === 'home' && (
                                <>
                                    <div className="search-bar">
                                        <span className="search-icon">üîç</span>
                                        <input
                                            type="text"
                                            placeholder="Ï±Ö Ï†úÎ™©, Ï†ÄÏûê, ÌÖåÎßàÎ°ú Í≤ÄÏÉâ..."
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                        />
                                    </div>
                                    <button
                                        className="add-book-btn"
                                        onClick={() => setShowAddForm(true)}
                                    >
                                        <span>‚ûï</span>
                                        <span>Ï±Ö Ï∂îÍ∞Ä</span>
                                    </button>
                                </>
                            )}
                        </div>

                    {/* Ìôà ÌôîÎ©¥ */}
                    {currentView === 'home' && (
                        <div>
                            {/* Í≤ÄÏÉâ Í≤∞Í≥º ÌëúÏãú */}
                            {searchTerm && (
                                <Section
                                    title={`üîç Í≤ÄÏÉâ Í≤∞Í≥º: "${searchTerm}"`}
                                    subtitle={`${books.filter(b => 
                                        b.fields['Ï†úÎ™©']?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                        b.fields['Ï†ÄÏûê']?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                        b.fields['ÌÖåÎßà']?.toLowerCase().includes(searchTerm.toLowerCase())
                                    ).length}Í∂å Î∞úÍ≤¨`}
                                >
                                    <div style={{
                                        display: 'grid',
                                        gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
                                        gap: '1.5rem'
                                    }}>
                                        {books
                                            .filter(b => 
                                                b.fields['Ï†úÎ™©']?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                                b.fields['Ï†ÄÏûê']?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                                b.fields['ÌÖåÎßà']?.toLowerCase().includes(searchTerm.toLowerCase())
                                            )
                                            .slice(0, 12)
                                            .map(book => {
                                                const log = readingLogs.find(l => l.fields['Ï±Ö']?.[0] === book.id);
                                                return (
                                                    <BookCard
                                                        key={book.id}
                                                        book={book}
                                                        log={log}
                                                        onClick={() => selectBook(book)}
                                                    />
                                                );
                                            })}
                                    </div>
                                    {books.filter(b => 
                                        b.fields['Ï†úÎ™©']?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                        b.fields['Ï†ÄÏûê']?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                        b.fields['ÌÖåÎßà']?.toLowerCase().includes(searchTerm.toLowerCase())
                                    ).length > 12 && (
                                        <button
                                            onClick={() => changeView('all', { searchTerm: searchTerm })}
                                            style={{
                                                width: '100%',
                                                padding: '0.75rem',
                                                marginTop: '1rem',
                                                background: '#FF69B4',
                                                border: 'none',
                                                borderRadius: '10px',
                                                color: 'white',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            Ï†ÑÏ≤¥ Í≤ÄÏÉâ Í≤∞Í≥º Î≥¥Í∏∞ ‚Üí
                                        </button>
                                    )}
                                </Section>
                            )}

                            {!searchTerm && (
                                <>
                            {/* ÌôòÏòÅ ÏÑπÏÖò */}
                            <div className="welcome-section">
                                <h1 className="welcome-title">
                                    Welcome back, Ïö∞ÎûåÏù¥! üëã
                                </h1>
                                <p className="welcome-subtitle">
                                    Ïò§ÎäòÎèÑ Ïû¨ÎØ∏ÏûàÎäî Ï±ÖÏùÑ Ï∞æÏïÑÎ≥ºÍπåÏöî?
                                </p>
                            </div>

                            {/* ÌÜµÍ≥Ñ Ïπ¥Îìú */}
                            <div className="stats-grid">
                                <div 
                                    className="stat-card"
                                    onClick={() => goHome()}
                                >
                                    <div className="stat-icon" style={{ background: '#E3F2FD', borderRadius: '12px' }}>
                                        üìö
                                    </div>
                                    <div className="stat-value">{stats.total}</div>
                                    <div className="stat-label">Ï†ÑÏ≤¥ Ï±Ö</div>
                                </div>
                                <div 
                                    className="stat-card"
                                    onClick={() => changeView('filter', { filterType: 'read' })}
                                >
                                    <div className="stat-icon" style={{ background: '#E8F5E9', borderRadius: '12px' }}>
                                        üìñ
                                    </div>
                                    <div className="stat-value">{stats.read}</div>
                                    <div className="stat-label">ÏùΩÏùÄ Ï±Ö</div>
                                </div>
                                <div 
                                    className="stat-card"
                                    onClick={() => changeView('filter', { filterType: 'interested' })}
                                >
                                    <div className="stat-icon" style={{ background: '#FFF3E0', borderRadius: '12px' }}>
                                        ‚ù§Ô∏è
                                    </div>
                                    <div className="stat-value">{stats.interested}</div>
                                    <div className="stat-label">Í¥ÄÏã¨Ï±Ö</div>
                                </div>
                            </div>

                            {/* Ï∂îÏ≤ú ÏÑπÏÖò */}
                            {recommendations.length > 0 && (
                                <div className="section">
                                    <div className="section-header">
                                        <div className="section-title">
                                            <span>Ïö∞ÎûåÏù¥Î•º ÏúÑÌïú Ï∂îÏ≤ú</span>
                                        </div>
                                        <button
                                            onClick={() => {
                                                localStorage.removeItem('todayRecommendations');
                                                loadTodayRecommendations(true);
                                            }}
                                            disabled={recommendationsLoading}
                                            style={{
                                                padding: '0.5rem 1rem',
                                                background: recommendationsLoading ? '#ccc' : 'white',
                                                border: '1px solid #E5E5E5',
                                                borderRadius: '20px',
                                                color: '#8B7EC8',
                                                fontSize: '0.85rem',
                                                cursor: recommendationsLoading ? 'not-allowed' : 'pointer',
                                                opacity: recommendationsLoading ? 0.6 : 1
                                            }}
                                        >
                                            {recommendationsLoading ? 'Î°úÎî© Ï§ë...' : 'ÏÉàÎ°úÍ≥†Ïπ®'}
                                        </button>
                                    </div>
                                    <p className="section-subtitle">
                                        ÏùΩÍ∏∞ Í¥ÄÏã¨ÏÇ¨ÏôÄ Ï¢ãÏïÑÌïòÎäî Ï±ÖÏùÑ Í∏∞Î∞òÏúºÎ°ú Ï∂îÏ≤úÌï©ÎãàÎã§
                                    </p>
                                    <div 
                                        className="horizontal-scroll"
                                        style={{
                                        display: 'flex',
                                        overflowX: 'auto',
                                        overflowY: 'visible',
                                        gap: '1rem',
                                        paddingTop: '0.5rem',
                                        paddingBottom: '1rem',
                                        scrollbarWidth: 'thin',
                                        scrollbarColor: '#FFB6C1 #f5f5f5',
                                        WebkitOverflowScrolling: 'touch'
                                    }}>
                                        {recommendations.map(item => (
                                            <div 
                                                key={item.book.id}
                                                style={{
                                                    minWidth: '250px',
                                                    maxWidth: '250px'
                                                }}
                                            >
                                                <div 
                                                    onClick={() => selectBook(item.book)}
                                                    style={{
                                                        background: 'white',
                                                        borderRadius: '15px',
                                                        padding: '1.5rem',
                                                        border: '2px solid #FFB6C1',
                                                        boxShadow: '0 2px 8px rgba(0,0,0,0.05)',
                                                        position: 'relative',
                                                        cursor: 'pointer',
                                                        transition: 'all 0.2s'
                                                    }}
                                                    onMouseEnter={(e) => {
                                                        e.currentTarget.style.transform = 'translateY(-5px)';
                                                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                                                    }}
                                                    onMouseLeave={(e) => {
                                                        e.currentTarget.style.transform = 'translateY(0)';
                                                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';
                                                    }}
                                                >
                                                    {item.book.fields['ÌëúÏßÄÏù¥ÎØ∏ÏßÄ'] && (
                                                        <div style={{
                                                            width: '100%',
                                                            height: '180px',
                                                            marginBottom: '1rem',
                                                            borderRadius: '10px',
                                                            overflow: 'hidden',
                                                            background: '#f5f5f5'
                                                        }}>
                                                            <img 
                                                                src={item.book.fields['ÌëúÏßÄÏù¥ÎØ∏ÏßÄ']} 
                                                                alt={item.book.fields['Ï†úÎ™©']}
                                                                style={{
                                                                    width: '100%',
                                                                    height: '100%',
                                                                    objectFit: 'cover'
                                                                }}
                                                            />
                                                        </div>
                                                    )}
                                                    
                                                    <h3 style={{
                                                        fontSize: '1.1rem',
                                                        color: '#333',
                                                        marginBottom: '0.5rem',
                                                        overflow: 'hidden',
                                                        textOverflow: 'ellipsis',
                                                        whiteSpace: 'nowrap'
                                                    }}>
                                                        {item.book.fields['Ï†úÎ™©']}
                                                    </h3>
                                                    
                                                    <p style={{ 
                                                        fontSize: '0.85rem', 
                                                        color: '#666',
                                                        marginBottom: '0.5rem'
                                                    }}>
                                                        {item.book.fields['Ï†ÄÏûê']}
                                                    </p>
                                                    
                                                    <p style={{ 
                                                        fontSize: '0.8rem', 
                                                        color: '#999',
                                                        marginBottom: '1rem'
                                                    }}>
                                                        {item.book.fields['Ï∂úÌåêÏÇ¨']}
                                                    </p>
                                                    
                                                    {/* Ïö∞Î¶¨ÏïÑÏù¥ÏóêÍ≤å Ï∂îÏ≤úÌïòÎäî Ïù¥Ïú† */}
                                                    {item.recommendationReason && (
                                                        <div style={{
                                                            padding: '0.75rem',
                                                            background: '#F5F5F5',
                                                            borderRadius: '10px',
                                                            fontSize: '0.85rem',
                                                            color: '#333',
                                                            lineHeight: '1.5'
                                                        }}>
                                                            <div style={{
                                                                fontSize: '0.75rem',
                                                                color: '#666',
                                                                fontWeight: '600',
                                                                marginBottom: '0.5rem'
                                                            }}>
                                                                üíù Ïö∞Î¶¨ÏïÑÏù¥ÏóêÍ≤å Ï∂îÏ≤úÌïòÎäî Ïù¥Ïú†
                                                            </div>
                                                            <div>
                                                                {item.recommendationReason}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Ïã†Í∞Ñ ÏÑπÏÖò */}
                            {aladinNewBooks.length > 0 && (
                                <div className="section">
                                    <div className="section-header">
                                        <div className="section-title">
                                            <span>Ïã†Í∞Ñ</span>
                                        </div>
                                        <button
                                            onClick={() => {
                                                localStorage.removeItem('aladinNewBooks');
                                                loadAladinNewBooks(true);
                                            }}
                                            disabled={aladinLoading}
                                            style={{
                                                padding: '0.5rem 1rem',
                                                background: aladinLoading ? '#ccc' : 'white',
                                                border: '1px solid #E5E5E5',
                                                borderRadius: '20px',
                                                color: '#8B7EC8',
                                                fontSize: '0.85rem',
                                                cursor: aladinLoading ? 'not-allowed' : 'pointer',
                                                opacity: aladinLoading ? 0.6 : 1
                                            }}
                                        >
                                            {aladinLoading ? 'Î°úÎî© Ï§ë...' : 'ÏÉàÎ°úÍ≥†Ïπ®'}
                                        </button>
                                    </div>
                                    <p className="section-subtitle">
                                        ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú Ïã†ÏÑ†Ìïú Ïù¥ÏïºÍ∏∞Îì§ ¬∑ {(() => {
                                            try {
                                                const cached = localStorage.getItem('aladinNewBooks');
                                                if (cached) {
                                                    const { date } = JSON.parse(cached);
                                                    if (date) {
                                                        const [year, month] = date.split('-');
                                                        return `${year}ÎÖÑ ${parseInt(month)}Ïõî ÏóÖÎç∞Ïù¥Ìä∏`;
                                                    }
                                                }
                                            } catch (e) {}
                                            return '';
                                        })()}
                                    </p>
                                    <div 
                                        className="horizontal-scroll"
                                        style={{
                                        display: 'flex',
                                        overflowX: 'auto',
                                        overflowY: 'visible',
                                        gap: '1rem',
                                        paddingTop: '0.5rem',
                                        paddingBottom: '1rem',
                                        scrollbarWidth: 'thin',
                                        scrollbarColor: '#FFB6C1 #f5f5f5',
                                        WebkitOverflowScrolling: 'touch'
                                    }}>
                                        {aladinNewBooks.map((book, idx) => (
                                            <div 
                                                key={idx}
                                                style={{
                                                    minWidth: '250px',
                                                    maxWidth: '250px'
                                                }}
                                            >
                                                <div 
                                                    onClick={() => setSelectedAladinBook(book)}
                                                    style={{
                                                        background: 'white',
                                                        borderRadius: '15px',
                                                        padding: '1.5rem',
                                                        border: '2px solid #98D8C8',
                                                        boxShadow: '0 2px 8px rgba(0,0,0,0.05)',
                                                        position: 'relative',
                                                        cursor: 'pointer',
                                                        transition: 'all 0.2s'
                                                    }}
                                                    onMouseEnter={(e) => {
                                                        e.currentTarget.style.transform = 'translateY(-5px)';
                                                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                                                    }}
                                                    onMouseLeave={(e) => {
                                                        e.currentTarget.style.transform = 'translateY(0)';
                                                        e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';
                                                    }}
                                                >
                                                    <span style={{
                                                        position: 'absolute',
                                                        top: '0.5rem',
                                                        right: '0.5rem',
                                                        background: '#98D8C8',
                                                        color: 'white',
                                                        padding: '0.25rem 0.5rem',
                                                        borderRadius: '20px',
                                                        fontSize: '0.7rem',
                                                        fontWeight: 'bold'
                                                    }}>
                                                        NEW
                                                    </span>
                                                    
                                                    {book.cover && (
                                                        <div style={{
                                                            width: '100%',
                                                            height: '180px',
                                                            marginBottom: '1rem',
                                                            borderRadius: '10px',
                                                            overflow: 'hidden',
                                                            background: '#f5f5f5'
                                                        }}>
                                                            <img 
                                                                src={book.cover} 
                                                                alt={book.title}
                                                                style={{
                                                                    width: '100%',
                                                                    height: '100%',
                                                                    objectFit: 'cover'
                                                                }}
                                                            />
                                                        </div>
                                                    )}
                                                    
                                                    <h3 style={{
                                                        fontSize: '1.1rem',
                                                        color: '#333',
                                                        marginBottom: '0.5rem',
                                                        overflow: 'hidden',
                                                        textOverflow: 'ellipsis',
                                                        whiteSpace: 'nowrap'
                                                    }}>
                                                        {book.title}
                                                    </h3>
                                                    
                                                    <p style={{ 
                                                        fontSize: '0.85rem', 
                                                        color: '#666',
                                                        marginBottom: '0.5rem'
                                                    }}>
                                                        {book.author}
                                                    </p>
                                                    
                                                    <p style={{ 
                                                        fontSize: '0.8rem', 
                                                        color: '#999'
                                                    }}>
                                                        {book.publisher} ¬∑ {book.pubDate ? book.pubDate.substring(0, 4) : ''}
                                                    </p>
                                                    
                                                    {/* Ïö∞Î¶¨ÏïÑÏù¥ÏóêÍ≤å Ï∂îÏ≤úÌïòÎäî Ïù¥Ïú† */}
                                                    <div style={{
                                                        marginTop: '1rem',
                                                        padding: '0.75rem',
                                                        background: '#F5F5F5',
                                                        borderRadius: '10px',
                                                        fontSize: '0.85rem',
                                                        color: '#333',
                                                        lineHeight: '1.5'
                                                    }}>
                                                        <div style={{
                                                            fontSize: '0.75rem',
                                                            color: '#666',
                                                            fontWeight: '600',
                                                            marginBottom: '0.5rem'
                                                        }}>
                                                            üíù Ïö∞Î¶¨ÏïÑÏù¥ÏóêÍ≤å Ï∂îÏ≤úÌïòÎäî Ïù¥Ïú†
                                                        </div>
                                                        <div>
                                                            {book.recommendationReason || '4~7ÏÑ∏ ÏïÑÏù¥Ïùò Î∞úÎã¨ Îã®Í≥ÑÏóê ÎßûÎäî Ï∞ΩÏûë Í∑∏Î¶ºÏ±ÖÏûÖÎãàÎã§.'}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* üìñ Ï±ïÌÑ∞Î∂Å Ï†ÑÌôò ÏïàÎÇ¥ */}
                            {chapterBookReadiness && (
                                <div style={{
                                    background: 'linear-gradient(135deg, #E6F3FF 0%, #F0E6FF 100%)',
                                    borderRadius: '20px',
                                    padding: '2rem',
                                    marginBottom: '2rem',
                                    border: '2px solid #B8E6FF'
                                }}>
                                    <h3 style={{
                                        fontSize: '1.5rem',
                                        color: '#4A90E2',
                                        marginBottom: '1rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '0.5rem'
                                    }}>
                                        üåü Ïö∞ÎûåÏù¥Ïùò Îã§Ïùå Îã®Í≥Ñ
                                    </h3>
                                    <p style={{
                                        fontSize: '1rem',
                                        color: '#555',
                                        lineHeight: '1.6',
                                        marginBottom: '1rem'
                                    }}>
                                        {chapterBookReadiness.level === 'STRONG' 
                                            ? 'ÏßÄÍ∏à Ïö∞ÎûåÏù¥Îäî Í∑∏Î¶ºÏ±ÖÎ≥¥Îã§ Ïù¥ÏïºÍ∏∞ Ï§ëÏã¨ Ï±ÖÏùÑ Îçî Ïû¨ÎØ∏ÏûàÏñ¥Ìï† Ï§ÄÎπÑÍ∞Ä Îêú Í≤É Í∞ôÏïÑÏöî. ÏßßÏùÄ Ï±ïÌÑ∞Î°ú ÎÇòÎâú Ï±ÖÎèÑ Î∂ÄÎã¥ ÏóÜÏù¥ ÏãúÏûëÌï¥Î≥º Ïàò ÏûàÎäî ÏãúÍ∏∞ÏòàÏöî.'
                                            : 'ÏöîÏ¶òÏ≤òÎüº Í∏¥ Ïù¥ÏïºÍ∏∞Î•º Ïûò Îì£ÎäîÎã§Î©¥, Í∏ÄÎ∞•Ïù¥ Ï°∞Í∏à Îçî ÎßéÏùÄ Ï±ÖÎèÑ Ï∂©Î∂ÑÌûà Ï¶êÍ∏∏ Ïàò ÏûàÏñ¥Ïöî.'}
                                    </p>
                                    <div style={{
                                        fontSize: '0.85rem',
                                        color: '#666',
                                        background: 'rgba(255,255,255,0.7)',
                                        padding: '0.75rem',
                                        borderRadius: '10px'
                                    }}>
                                        üí° Ïù¥ÏïºÍ∏∞Ï±ÖÏúºÎ°ú ÏûêÏó∞Ïä§ÎüΩÍ≤å ÎÑòÏñ¥Í∞ÄÎ©¥ ÎèÖÏÑú ÏûêÏã†Í∞êÏù¥ Îçî Ïª§Ïßà Ïàò ÏûàÏñ¥Ïöî
                                    </div>
                                </div>
                            )}

                            {/* ÏùΩÍ≥† ÏûàÎäî Ï±Ö - Ï†úÍ±∞Îê® */}
                            {false && (
                                <Section
                                    title="üìñ ÏùΩÍ≥† ÏûàÎäî Ï±Ö"
                                    subtitle={`${currentlyReading.length}Í∂å`}
                                >
                                    <div style={{
                                        display: 'grid',
                                        gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',
                                        gap: '1rem'
                                    }}>
                                        {currentlyReading.map(book => {
                                            const log = readingLogs.find(l => l.fields['Ï±Ö']?.[0] === book.id);
                                            return (
                                                <BookCard
                                                    key={book.id}
                                                    book={book}
                                                    log={log}
                                                    onClick={() => selectBook(book)}
                                                    compact
                                                />
                                            );
                                        })}
                                    </div>
                                </Section>
                            )}

                            </>
                            )}
                        </div>
                    )}

                    {/* Ï†ÑÏßë Î≥¥Í∏∞ */}
                    {currentView === 'collection' && (
                        <CollectionView
                            collections={collections}
                            books={books}
                            onBack={() => goHome()}
                            onSelectBook={selectBook}
                        />
                    )}

                    {/* ÌÖåÎßà Î≥¥Í∏∞ */}
                    {currentView === 'theme' && selectedTheme && (
                        <ThemeView
                            theme={selectedTheme}
                            books={books.filter(b => b.fields['ÌÖåÎßà']?.includes(selectedTheme))}
                            onBack={() => goHome()}
                            onSelectBook={selectBook}
                        />
                    )}

                    {/* Ï†ÑÏ≤¥ Î≥¥Í∏∞ */}
                    {currentView === 'all' && (
                        <AllBooksView
                            books={books}
                            readingLogs={readingLogs}
                            onBack={() => goHome()}
                            onSelectBook={selectBook}
                        />
                    )}

                    {/* ÌïÑÌÑ∞ Î≥¥Í∏∞ (ÏùΩÏùå, ÏµúÏï†, Í¥ÄÏã¨ ÏûàÎäî Ï±Ö) */}
                    {currentView === 'filter' && filterType && (
                        <FilterView
                            filterType={filterType}
                            books={books}
                            readingLogs={readingLogs}
                            onBack={() => {
                                goHome();
                                setFilterType(null);
                            }}
                            onSelectBook={selectBook}
                            setShowSearchModal={setShowSearchModal}
                        />
                    )}

                    {/* Ï±Ö Ï∂îÍ∞Ä Î™®Îã¨ */}
                    {showAddForm && (
                        <AddBookModal
                            onClose={() => setShowAddForm(false)}
                            onAdd={async (title, author) => {
                                // Ï±ÖÏù¥ Ïù¥ÎØ∏ Ï∂îÍ∞ÄÎêòÏóàÏúºÎØÄÎ°ú ÏÉàÎ°úÍ≥†Ïπ®Îßå
                                await loadData(); // ÏÉàÎ°úÍ≥†Ïπ®
                                setShowAddForm(false);
                            }}
                        />
                    )}

                    {/* Í≤ÄÏÉâ Î™®Îã¨ */}
                    {showSearchModal && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0,0,0,0.5)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 1000,
                            padding: '1rem'
                        }}
                        onClick={() => {
                            stopSearchCamera();
                            setSearchScanOpen(false);
                            setSearchScanImage(null);
                            setSearchScanMessage('');
                            setShowSearchModal(false);
                        }}
                        >
                            <div 
                                style={{
                                    background: 'white',
                                    borderRadius: '20px',
                                    padding: '2rem',
                                    maxWidth: '600px',
                                    width: '100%',
                                    maxHeight: '80vh',
                                    overflow: 'auto'
                                }}
                                onClick={(e) => e.stopPropagation()}
                            >
                                <h2 style={{ marginBottom: '1.5rem', color: '#FF69B4' }}>üìö Ï±Ö Í≤ÄÏÉâÌïòÍ∏∞</h2>
                                {!searchScanOpen ? (
                                    <button
                                        onClick={handleSearchScanStart}
                                        style={{
                                            width: '100%',
                                            padding: '0.75rem',
                                            marginBottom: '1rem',
                                            background: '#98D8C8',
                                            border: 'none',
                                            borderRadius: '10px',
                                            color: 'white',
                                            fontSize: '1rem',
                                            fontWeight: 'bold',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        üì∑ Î∞îÏΩîÎìúÎ°ú Í≤ÄÏÉâ
                                    </button>
                                ) : (
                                    <div style={{ marginBottom: '1rem' }}>
                                        <div style={{
                                            width: '100%',
                                            maxWidth: '400px',
                                            height: '220px',
                                            margin: '0 auto',
                                            borderRadius: '10px',
                                            overflow: 'hidden',
                                            position: 'relative',
                                            background: '#000'
                                        }}>
                                            {searchScanImage ? (
                                                <img
                                                    src={searchScanImage}
                                                    alt="captured barcode"
                                                    style={{
                                                        width: '100%',
                                                        height: '100%',
                                                        objectFit: 'cover'
                                                    }}
                                                />
                                            ) : (
                                                <video
                                                    ref={searchVideoRef}
                                                    style={{
                                                        width: '100%',
                                                        height: '100%',
                                                        objectFit: 'cover'
                                                    }}
                                                    playsInline
                                                    muted
                                                    onLoadedMetadata={() => setSearchScanReady(true)}
                                                ></video>
                                            )}
                                            <canvas ref={searchCanvasRef} style={{ display: 'none' }}></canvas>
                                        </div>
                                        <p style={{ 
                                            textAlign: 'center', 
                                            color: '#666', 
                                            fontSize: '0.9rem',
                                            marginTop: '0.5rem',
                                            marginBottom: '0.5rem'
                                        }}>
                                            {searchScanDecoding
                                                ? 'Î∞îÏΩîÎìú Î∂ÑÏÑù Ï§ë...'
                                                : (searchScanMessage
                                                    ? searchScanMessage
                                                    : (searchScanImage
                                                        ? 'ÏÇ¨ÏßÑÏù¥ Ï∞çÌòîÏäµÎãàÎã§. Ïù∏Ïãù Ïã§Ìå® Ïãú Îã§Ïãú Ï∞çÏñ¥Ï£ºÏÑ∏Ïöî.'
                                                        : (searchScanReady ? 'Î∞îÏΩîÎìúÎ•º ÌôîÎ©¥ Ï§ëÏïôÏóê ÎßûÏ∂ò Îí§ ÏÇ¨ÏßÑÏùÑ Ï∞çÏñ¥Ï£ºÏÑ∏Ïöî' : 'Ïπ¥Î©îÎùº Ï§ÄÎπÑ Ï§ë...')))}
                                        </p>
                                        {searchScanImage ? (
                                            <button
                                                onClick={handleSearchScanRetry}
                                                disabled={searchScanDecoding}
                                                style={{
                                                    width: '100%',
                                                    padding: '0.75rem',
                                                    background: searchScanDecoding ? '#ccc' : '#98D8C8',
                                                    border: 'none',
                                                    borderRadius: '10px',
                                                    color: 'white',
                                                    fontSize: '1rem',
                                                    fontWeight: 'bold',
                                                    cursor: searchScanDecoding ? 'not-allowed' : 'pointer'
                                                }}
                                            >
                                                üîÑ Îã§Ïãú Ï∞çÍ∏∞
                                            </button>
                                        ) : (
                                            <button
                                                onClick={handleSearchCapture}
                                                disabled={searchScanDecoding || !searchScanReady}
                                                style={{
                                                    width: '100%',
                                                    padding: '0.75rem',
                                                    background: (searchScanDecoding || !searchScanReady) ? '#ccc' : '#98D8C8',
                                                    border: 'none',
                                                    borderRadius: '10px',
                                                    color: 'white',
                                                    fontSize: '1rem',
                                                    fontWeight: 'bold',
                                                    cursor: (searchScanDecoding || !searchScanReady) ? 'not-allowed' : 'pointer'
                                                }}
                                            >
                                                üì∏ ÏÇ¨ÏßÑ Ï∞çÍ∏∞
                                            </button>
                                        )}
                                        <button
                                            onClick={() => {
                                                stopSearchCamera();
                                                setSearchScanOpen(false);
                                                setSearchScanImage(null);
                                                setSearchScanMessage('');
                                            }}
                                            style={{
                                                width: '100%',
                                                padding: '0.75rem',
                                                marginTop: '0.5rem',
                                                background: '#f0f0f0',
                                                border: 'none',
                                                borderRadius: '10px',
                                                color: '#666',
                                                fontSize: '0.95rem',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            Îã´Í∏∞
                                        </button>
                                    </div>
                                )}

                                <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.5rem' }}>
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && searchAladinBooks(searchQuery)}
                                        placeholder="Ï±Ö Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                        style={{
                                            flex: 1,
                                            padding: '0.75rem',
                                            fontSize: '1rem',
                                            border: '2px solid #ddd',
                                            borderRadius: '10px'
                                        }}
                                    />
                                    <button
                                        onClick={() => searchAladinBooks(searchQuery)}
                                        disabled={searchLoading}
                                        style={{
                                            padding: '0.75rem 1.5rem',
                                            background: searchLoading ? '#ccc' : '#FF69B4',
                                            border: 'none',
                                            borderRadius: '10px',
                                            color: 'white',
                                            fontSize: '1rem',
                                            fontWeight: 'bold',
                                            cursor: searchLoading ? 'not-allowed' : 'pointer'
                                        }}
                                    >
                                        {searchLoading ? 'Í≤ÄÏÉâ Ï§ë...' : 'Í≤ÄÏÉâ'}
                                    </button>
                                </div>
                                
                                {searchLoading && (
                                    <div style={{ textAlign: 'center', padding: '2rem', color: '#FF69B4' }}>
                                        üîç Í≤ÄÏÉâ Ï§ë...
                                    </div>
                                )}
                                
                                {!searchLoading && searchResults.length === 0 && searchQuery && (
                                    <div style={{ textAlign: 'center', padding: '2rem', color: '#999' }}>
                                        Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§
                                    </div>
                                )}
                                
                                {searchResults.length > 0 && (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                        {searchResults.map(book => (
                                            <div key={book.isbn} style={{
                                                display: 'flex',
                                                gap: '1rem',
                                                padding: '1rem',
                                                border: '1px solid #eee',
                                                borderRadius: '10px'
                                            }}>
                                                <img 
                                                    src={book.cover} 
                                                    alt={book.title}
                                                    style={{
                                                        width: '80px',
                                                        height: '120px',
                                                        objectFit: 'cover',
                                                        borderRadius: '8px'
                                                    }}
                                                />
                                                <div style={{ flex: 1 }}>
                                                    <h4 style={{ marginBottom: '0.5rem' }}>{book.title}</h4>
                                                    <p style={{ fontSize: '0.9rem', color: '#666', marginBottom: '0.5rem' }}>
                                                        {book.author} | {book.publisher}
                                                    </p>
                                                    <button
                                                        onClick={() => addInterestedBook(book)}
                                                        style={{
                                                            padding: '0.5rem 1rem',
                                                            background: '#DDA0DD',
                                                            border: 'none',
                                                            borderRadius: '8px',
                                                            color: 'white',
                                                            fontSize: '0.9rem',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        üí° Í¥ÄÏã¨ ÏûàÎäî Ï±Ö Ï∂îÍ∞Ä
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                <button
                                    onClick={() => {
                                        stopSearchCamera();
                                        setSearchScanOpen(false);
                                        setSearchScanImage(null);
                                        setSearchScanMessage('');
                                        setShowSearchModal(false);
                                        setSearchQuery('');
                                        setSearchResults([]);
                                    }}
                                    style={{
                                        width: '100%',
                                        padding: '0.75rem',
                                        marginTop: '1.5rem',
                                        background: 'white',
                                        border: '2px solid #FFB6C1',
                                        borderRadius: '10px',
                                        color: '#FF69B4',
                                        fontSize: '1rem',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Îã´Í∏∞
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Ï±Ö ÏÉÅÏÑ∏ Î™®Îã¨ */}
                    {selectedBook && (
                        <BookDetailModal
                            book={selectedBook}
                            log={readingLogs.find(l => l.fields['Ï±Ö']?.[0] === selectedBook.id)}
                            onClose={closeBook}
                            updateReadingLog={updateReadingLog}
                            onDataUpdate={loadData}
                        />
                    )}

                    {/* ÏïåÎùºÎîò Ïã†Í∞Ñ Î™®Îã¨ */}
                    {selectedAladinBook && (
                        <AladinBookModal
                            book={selectedAladinBook}
                            onClose={() => setSelectedAladinBook(null)}
                            onAdd={async () => {
                                try {
                                    const response = await fetch('/api/add-interested-book', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ isbn: selectedAladinBook.isbn })
                                    });
                                    
                                    const data = await response.json();
                                    
                                    if (data.success) {
                                        alert(data.isNew ? 'ÏÉà Ï±ÖÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!' : 'Ïù¥ÎØ∏ Îì±Î°ùÎêú Ï±ÖÏûÖÎãàÎã§!');
                                        // Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® (books Î∞∞Ïó¥ ÏóÖÎç∞Ïù¥Ìä∏) - Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®
                                        setLoading(true);
                                        await loadData();
                                        setLoading(false);
                                        // Í≤ÄÏÉâ Í≤∞Í≥ºÎèÑ ÏÉàÎ°úÍ≥†Ïπ®ÏùÑ ÏúÑÌï¥ Î™®Îã¨ Îã´Í∏∞
                                        setSelectedAladinBook(null);
                                        // Í≤ÄÏÉâÏñ¥Í∞Ä ÏûàÏúºÎ©¥ Í≤ÄÏÉâ Í≤∞Í≥ºÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                                        if (searchTerm) {
                                            // Í≤ÄÏÉâ Í≤∞Í≥º ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌï¥ ÏïΩÍ∞ÑÏùò ÏßÄÏó∞
                                            setTimeout(() => {
                                                console.log('üìö Ï±Ö Ï∂îÍ∞Ä ÌõÑ Í≤ÄÏÉâ Í≤∞Í≥º ÏóÖÎç∞Ïù¥Ìä∏');
                                            }, 500);
                                        }
                                    } else {
                                        alert('Ïò§Î•ò: ' + data.error);
                                    }
                                } catch (error) {
                                    console.error('Ï±Ö Ï∂îÍ∞Ä Ïò§Î•ò:', error);
                                    alert('Ï±Ö Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
                                }
                            }}
                            onAddToInterested={async () => {
                                try {
                                    // AirtableÏóêÏÑú Ï±Ö Ï∞æÍ∏∞
                                    const booksData = await fetchAirtable(CONFIG.BOOKS_TABLE);
                                    const existingBook = booksData.find(b => 
                                        (b.fields['ISBN'] && selectedAladinBook.isbn && b.fields['ISBN'] === selectedAladinBook.isbn) ||
                                        (b.fields['Ï†úÎ™©'] && selectedAladinBook.title && b.fields['Ï†úÎ™©'] === selectedAladinBook.title)
                                    );
                                    
                                    if (existingBook) {
                                        // Ïù¥ÎØ∏ ÏûàÎäî Ï±ÖÏù¥Î©¥ Í¥ÄÏã¨ ÌïÑÎìúÎßå ÏóÖÎç∞Ïù¥Ìä∏
                                        const response = await fetch('/api/update-book-field', {
                                            method: 'PATCH',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                                recordId: existingBook.id,
                                                fields: {
                                                    'Í¥ÄÏã¨': true
                                                }
                                            })
                                        });
                                        
                                        const data = await response.json();
                                        if (data.success) {
                                            alert('Í¥ÄÏã¨Ï±ÖÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!');
                                            await loadData();
                                            setSelectedAladinBook(null);
                                        } else {
                                            alert('Ïò§Î•ò: ' + (data.error || 'Ï†ÄÏû• Ïã§Ìå®'));
                                        }
                                    } else {
                                        alert('Î®ºÏ†Ä "Ï±Ö Ï∂îÍ∞ÄÌïòÍ∏∞"Î•º ÎàåÎü¨ Ï±ÖÏùÑ Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.');
                                    }
                                } catch (error) {
                                    console.error('Í¥ÄÏã¨Ï±Ö Ï∂îÍ∞Ä Ïò§Î•ò:', error);
                                    alert('Í¥ÄÏã¨Ï±Ö Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
                                }
                            }}
                        />
                    )}

                    {/* ÏÑ§Ï†ï ÌéòÏù¥ÏßÄ */}
                    {currentView === 'settings' && (
                        <SettingsView
                            profile={childProfile}
                            onSave={saveChildProfile}
                        />
                    )}
                    </div>
                </div>
            );
        }

        // üìñ ÏïåÎùºÎîò APIÎ°ú Ï±Ö Ï†ïÎ≥¥ Í≤ÄÏÉâ (JSONP Î∞©Ïãù)
        async function searchAladinBook(title) {
            return new Promise((resolve) => {
                try {
                    // JSONP ÏΩúÎ∞± Ìï®ÏàòÎ™Ö
                    const callbackName = 'aladinCallback_' + Date.now();
                    
                    // Í∏ÄÎ°úÎ≤å ÏΩúÎ∞± Îì±Î°ù
                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        
                        if (data.item && data.item.length > 0) {
                            const book = data.item[0];
                            resolve({
                                found: true,
                                Ï†ÄÏûê: book.author || '',
                                Ï∂úÌåêÏÇ¨: book.publisher || '',
                                Î∞úÌñâÎÖÑ: book.pubDate ? parseInt(book.pubDate.substring(0, 4)) : null,
                                ÌëúÏßÄÏù¥ÎØ∏ÏßÄ: book.cover || '',
                                ISBN: book.isbn13 || book.isbn || '',
                                ÏÑ§Î™Ö: book.description || ''
                            });
                        } else {
                            resolve({ found: false });
                        }
                    };
                    
                    // JSONP Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÉùÏÑ±
                    const script = document.createElement('script');
                    script.src = `https://www.aladin.co.kr/ttb/api/ItemSearch.aspx?ttbkey=${CONFIG.ALADIN_API_KEY}&Query=${encodeURIComponent(title)}&QueryType=Title&MaxResults=3&start=1&SearchTarget=Book&output=js&Version=20131101&Cover=Big&callback=${callbackName}`;
                    
                    script.onerror = () => {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        resolve({ found: false });
                    };
                    
                    document.body.appendChild(script);
                    
                    // ÌÉÄÏûÑÏïÑÏõÉ
                    setTimeout(() => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                            if (document.body.contains(script)) {
                                document.body.removeChild(script);
                            }
                            resolve({ found: false });
                        }
                    }, 10000);
                    
                } catch (error) {
                    console.error('ÏïåÎùºÎîò API Ïò§Î•ò:', error);
                    resolve({ found: false });
                }
            });
        }

        // üìö ÏïåÎùºÎîò API + AIÎ°ú Ï±Ö Ï†ïÎ≥¥ ÏÉùÏÑ± Î∞è Airtable Ï∂îÍ∞Ä
        async function generateBookData(title, author = '') {
            try {
                console.log('üìñ Ï±Ö Ï†ïÎ≥¥ ÏÉùÏÑ± Ï§ë...');
                
                const response = await fetch('/api/ai-generate-book', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, author })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Ï±Ö Ï∂îÍ∞Ä Ïã§Ìå®');
                }

                const result = await response.json();
                
                if (result.success) {
                    const successMsg = result.aladinData?.found 
                        ? '‚úÖ ÏïåÎùºÎîòÏóêÏÑú Ï†ïÎ≥¥Î•º Ï∞æÏïÑ Ï±ÖÏùÑ Ï∂îÍ∞ÄÌñàÏñ¥Ïöî!' 
                        : '‚úÖ AIÍ∞Ä Ï±Ö Ï†ïÎ≥¥Î•º ÏÉùÏÑ±Ìï¥ Ï∂îÍ∞ÄÌñàÏñ¥Ïöî!';
                    alert(successMsg);
                    return true;
                } else {
                    alert('‚ùå Ï∂îÍ∞Ä Ïã§Ìå®');
                    return false;
                }

            } catch (error) {
                console.error('Ï±Ö Ï∂îÍ∞Ä Ïò§Î•ò:', error);
                alert('‚ùå Ïò§Î•ò Î∞úÏÉù: ' + error.message);
                return false;
            }
        }

        function AddBookModal({ onClose, onAdd }) {
            const [title, setTitle] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [selectedBook, setSelectedBook] = useState(null);
            const [loading, setLoading] = useState(false);
            const [searching, setSearching] = useState(false);
            const [scanning, setScanning] = useState(false);
            const [isDecoding, setIsDecoding] = useState(false);
            const [isCameraReady, setIsCameraReady] = useState(false);
            const [capturedImage, setCapturedImage] = useState(null);
            const [scanMessage, setScanMessage] = useState('');
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const streamRef = useRef(null);

            const handleSearch = async () => {
                if (!title.trim()) {
                    alert('Ï±Ö Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                    return;
                }
                
                setSearching(true);
                try {
                    const response = await fetch(`/api/aladin-search?query=${encodeURIComponent(title.trim())}`);
                    const data = await response.json();
                    
                    if (data.success && data.books && data.books.length > 0) {
                        setSearchResults(data.books);
                    } else {
                        alert('Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§. Îã§Î•∏ Ï†úÎ™©ÏúºÎ°ú Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî.');
                        setSearchResults([]);
                    }
                } catch (error) {
                    console.error('Í≤ÄÏÉâ Ïò§Î•ò:', error);
                    alert('Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
                } finally {
                    setSearching(false);
                }
            };

            const stopCamera = () => {
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach((track) => track.stop());
                    streamRef.current = null;
                }
                if (videoRef.current) {
                    videoRef.current.srcObject = null;
                }
                setIsCameraReady(false);
            };

            const startCamera = () => {
                setIsCameraReady(false);
                setIsDecoding(false);
                setCapturedImage(null);
                setScanMessage('');

                navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { ideal: "environment" } },
                    audio: false
                }).then((stream) => {
                    streamRef.current = stream;
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        videoRef.current.play();
                    }
                }).catch((error) => {
                    console.error('Ïπ¥Î©îÎùº Ï†ëÍ∑º Ïò§Î•ò:', error);
                    alert('Ïπ¥Î©îÎùº Ï†ëÍ∑º Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú Ïπ¥Î©îÎùº Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.');
                    setScanning(false);
                });
            };

            // Î∞îÏΩîÎìú ÏÇ¨ÏßÑ Ï¥¨ÏòÅ ÏãúÏûë
            const handleStartScan = () => {
                if (!window.Quagga) {
                    alert('Î∞îÏΩîÎìú Ïä§Ï∫êÎÑà ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                setScanning(true);
                startCamera();
            };

            const handleCancelScan = () => {
                stopCamera();
                setScanning(false);
                setIsDecoding(false);
                setCapturedImage(null);
                setScanMessage('');
            };

            const handleCapturePhoto = () => {
                if (!videoRef.current || !canvasRef.current) {
                    return;
                }

                const video = videoRef.current;
                const canvas = canvasRef.current;
                if (!video.videoWidth || !video.videoHeight) {
                    alert('Ïπ¥Î©îÎùº Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                const width = video.videoWidth;
                const height = video.videoHeight;
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, width, height);

                const dataUrl = canvas.toDataURL('image/png');
                setCapturedImage(dataUrl);
                setScanMessage('');
                stopCamera();
                setIsDecoding(true);

                const tryDecode = (size) => new Promise((resolve) => {
                    Quagga.decodeSingle({
                        src: dataUrl,
                        numOfWorkers: 0,
                        inputStream: { size, singleChannel: false },
                        locator: { patchSize: "medium", halfSample: true },
                        decoder: {
                            readers: [
                                "ean_reader",
                                "ean_8_reader",
                                "upc_reader",
                                "upc_e_reader",
                                "code_128_reader"
                            ]
                        },
                        locate: true
                    }, (result) => resolve(result));
                });

                const attempt = async () => {
                    const sizes = [2000, 1600, 1200, 800];
                    for (const size of sizes) {
                        const result = await tryDecode(size);
                        if (result && result.codeResult && result.codeResult.code) {
                            return result.codeResult.code;
                        }
                    }
                    return null;
                };

                attempt().then((code) => {
                    setIsDecoding(false);
                    if (code) {
                        const isbn = code.replace(/[^0-9X]/g, '');
                        if (isbn.length === 10 || isbn.length === 13) {
                            stopCamera();
                            setScanning(false);
                            handleBarcodeScanned(isbn);
                            return;
                        }
                        setScanMessage('Ïò¨Î∞îÎ•∏ ISBN Î∞îÏΩîÎìúÎ•º Ïù∏ÏãùÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§. Îã§Ïãú Ï∞çÏñ¥Ï£ºÏÑ∏Ïöî.');
                    } else {
                        setScanMessage('Ïù∏Ïãù Ïã§Ìå®: Îçî Í∞ÄÍπåÏù¥/Î∞ùÏùÄ Í≥≥ÏóêÏÑú Îã§Ïãú Ï∞çÏñ¥Ï£ºÏÑ∏Ïöî.');
                    }
                });
            };

            // Î∞îÏΩîÎìúÎ°ú Ïä§Ï∫îÌïú ISBNÏúºÎ°ú Ï±Ö Í≤ÄÏÉâ
            const handleBarcodeScanned = async (isbn) => {
                setScanning(false);
                
                setSearching(true);
                try {
                    // ISBNÏúºÎ°ú ÏßÅÏ†ë Ï±Ö Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                    const response = await fetch(`/api/aladin-search?query=${encodeURIComponent(isbn)}&isbn=true`);
                    const data = await response.json();
                    
                    if (data.success && data.books && data.books.length > 0) {
                        // Ï≤´ Î≤àÏß∏ Í≤∞Í≥ºÎ•º ÏûêÎèôÏúºÎ°ú ÏÑ†ÌÉù
                        setSelectedBook(data.books[0]);
                        setSearchResults(data.books);
                    } else {
                        alert('Ïä§Ï∫îÌïú ISBNÏúºÎ°ú Ï±ÖÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÏàòÎèôÏúºÎ°ú Í≤ÄÏÉâÌï¥Ï£ºÏÑ∏Ïöî.');
                        setTitle(isbn);
                    }
                } catch (error) {
                    console.error('ISBN Í≤ÄÏÉâ Ïò§Î•ò:', error);
                    alert('Ï±Ö Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                } finally {
                    setSearching(false);
                }
            };

            // Ïª¥Ìè¨ÎÑåÌä∏ Ïñ∏ÎßàÏö¥Ìä∏ Ïãú Ïπ¥Î©îÎùº Ï†ïÎ¶¨
            useEffect(() => {
                return () => {
                    stopCamera();
                };
            }, []);

            // Î™®Îã¨ Îã´Í∏∞ Ìï∏Îì§Îü¨ (Ïä§Ï∫êÎÑà Ï†ïÎ¶¨ Ìè¨Ìï®)
            const handleClose = async () => {
                handleCancelScan();
                onClose();
            };

            const handleConfirm = async () => {
                if (!selectedBook) return;
                
                setLoading(true);
                try {
                    // ISBNÏúºÎ°ú Ï±Ö Ï∂îÍ∞Ä
                    const response = await fetch('/api/add-interested-book', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ isbn: selectedBook.isbn })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        await onAdd(selectedBook.title, selectedBook.author);
                    } else {
                        alert('Ïò§Î•ò: ' + data.error);
                    }
                } catch (error) {
                    console.error('Ï±Ö Ï∂îÍ∞Ä Ïò§Î•ò:', error);
                    alert('Ï±Ö Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div onClick={onClose} style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: '1rem'
                }}>
                    <div onClick={(e) => e.stopPropagation()} style={{
                        background: 'white',
                        borderRadius: '20px',
                        padding: '2rem',
                        maxWidth: '500px',
                        width: '100%',
                        position: 'relative'
                    }}>
                        {(isDecoding || searching) && (
                            <div style={{
                                position: 'absolute',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                background: 'rgba(255,255,255,0.85)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                borderRadius: '20px',
                                zIndex: 1
                            }}>
                                <div style={{ textAlign: 'center', color: '#666', fontSize: '0.95rem' }}>
                                    {isDecoding ? 'Î∞îÏΩîÎìú Î∂ÑÏÑù Ï§ë...' : 'Ï±Ö Ï†ïÎ≥¥Î•º Ï∞æÎäî Ï§ë...'}
                                </div>
                            </div>
                        )}
                        <h2 style={{ fontSize: '1.8rem', color: '#FF69B4', marginBottom: '1rem' }}>
                            ‚ûï ÏÉà Ï±Ö Ï∂îÍ∞Ä
                        </h2>
                        
                        {!selectedBook ? (
                            <>
                                <p style={{ color: '#666', marginBottom: '1.5rem', lineHeight: '1.6' }}>
                                    Ï±Ö Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÍ±∞ÎÇò Î∞îÏΩîÎìúÎ•º Ïä§Ï∫îÌïòÏó¨ Ï±ÖÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.
                                </p>

                                {!scanning ? (
                                    <button
                                        onClick={handleStartScan}
                                        disabled={searching || loading}
                                        style={{
                                            width: '100%',
                                            padding: '0.75rem',
                                            background: searching || loading ? '#ccc' : '#98D8C8',
                                            border: 'none',
                                            borderRadius: '10px',
                                            color: 'white',
                                            fontSize: '1rem',
                                            fontWeight: 'bold',
                                            cursor: searching || loading ? 'not-allowed' : 'pointer',
                                            marginBottom: '1rem'
                                        }}
                                    >
                                        üì∑ Î∞îÏΩîÎìú ÏÇ¨ÏßÑ Ï∞çÍ∏∞
                                    </button>
                                ) : (
                                    <div style={{ marginBottom: '1rem' }}>
                                        <div style={{
                                            width: '100%',
                                            maxWidth: '400px',
                                            height: '240px',
                                            margin: '0 auto',
                                            borderRadius: '10px',
                                            overflow: 'hidden',
                                            position: 'relative',
                                            background: '#000'
                                        }}>
                                            {capturedImage ? (
                                                <img
                                                    src={capturedImage}
                                                    alt="captured barcode"
                                                    style={{
                                                        width: '100%',
                                                        height: '100%',
                                                        objectFit: 'cover'
                                                    }}
                                                />
                                            ) : (
                                                <video
                                                    ref={videoRef}
                                                    style={{
                                                        width: '100%',
                                                        height: '100%',
                                                        objectFit: 'cover'
                                                    }}
                                                    playsInline
                                                    muted
                                                    onLoadedMetadata={() => setIsCameraReady(true)}
                                                ></video>
                                            )}
                                            <canvas ref={canvasRef} style={{ display: 'none' }}></canvas>
                                        </div>
                                        <p style={{ 
                                            textAlign: 'center', 
                                            color: '#666', 
                                            fontSize: '0.9rem',
                                            marginTop: '0.5rem',
                                            marginBottom: '0.5rem'
                                        }}>
                                            {isDecoding
                                                ? 'ÏÇ¨ÏßÑÏùÑ Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§...'
                                                : (scanMessage
                                                    ? scanMessage
                                                    : (capturedImage
                                                        ? 'ÏÇ¨ÏßÑÏù¥ Ï∞çÌòîÏäµÎãàÎã§. Ïù∏Ïãù Ïã§Ìå® Ïãú Îã§Ïãú Ï∞çÏñ¥Ï£ºÏÑ∏Ïöî.'
                                                        : (isCameraReady ? 'Î∞îÏΩîÎìúÎ•º ÌôîÎ©¥ Ï§ëÏïôÏóê ÎßûÏ∂ò Îí§ ÏÇ¨ÏßÑÏùÑ Ï∞çÏñ¥Ï£ºÏÑ∏Ïöî' : 'Ïπ¥Î©îÎùº Ï§ÄÎπÑ Ï§ë...')))}
                                        </p>
                                        {capturedImage ? (
                                            <button
                                                onClick={startCamera}
                                                disabled={isDecoding}
                                                style={{
                                                    width: '100%',
                                                    padding: '0.75rem',
                                                    background: isDecoding ? '#ccc' : '#98D8C8',
                                                    border: 'none',
                                                    borderRadius: '10px',
                                                    color: 'white',
                                                    fontSize: '1rem',
                                                    fontWeight: 'bold',
                                                    cursor: isDecoding ? 'not-allowed' : 'pointer'
                                                }}
                                            >
                                                üîÑ Îã§Ïãú Ï∞çÍ∏∞
                                            </button>
                                        ) : (
                                            <button
                                                onClick={handleCapturePhoto}
                                                disabled={isDecoding || !isCameraReady}
                                                style={{
                                                    width: '100%',
                                                    padding: '0.75rem',
                                                    background: (isDecoding || !isCameraReady) ? '#ccc' : '#98D8C8',
                                                    border: 'none',
                                                    borderRadius: '10px',
                                                    color: 'white',
                                                    fontSize: '1rem',
                                                    fontWeight: 'bold',
                                                    cursor: (isDecoding || !isCameraReady) ? 'not-allowed' : 'pointer'
                                                }}
                                            >
                                                üì∏ ÏÇ¨ÏßÑ Ï∞çÍ∏∞
                                            </button>
                                        )}
                                    </div>
                                )}

                                <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                                    <input
                                        type="text"
                                        placeholder="Ï±Ö Ï†úÎ™© *"
                                        value={title}
                                        onChange={(e) => setTitle(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && !searching && handleSearch()}
                                        disabled={searching || loading}
                                        style={{
                                            flex: 1,
                                            padding: '0.75rem',
                                            border: '2px solid #FFB6C1',
                                            borderRadius: '10px',
                                            fontSize: '1rem',
                                            outline: 'none'
                                        }}
                                        autoFocus
                                    />
                                    <button
                                        onClick={handleSearch}
                                        disabled={searching || !title.trim()}
                                        style={{
                                            padding: '0.75rem 1.5rem',
                                            background: searching || !title.trim() ? '#ccc' : '#FF69B4',
                                            border: 'none',
                                            borderRadius: '10px',
                                            color: 'white',
                                            fontSize: '1rem',
                                            fontWeight: 'bold',
                                            cursor: searching || !title.trim() ? 'not-allowed' : 'pointer'
                                        }}
                                    >
                                        {searching ? 'Í≤ÄÏÉâ Ï§ë...' : 'üîç Í≤ÄÏÉâ'}
                                    </button>
                                </div>

                                {searchResults.length > 0 && (
                                    <div style={{ 
                                        maxHeight: '300px', 
                                        overflowY: 'auto',
                                        marginBottom: '1rem',
                                        border: '1px solid #eee',
                                        borderRadius: '10px',
                                        padding: '0.5rem'
                                    }}>
                                        {searchResults.map(book => (
                                            <div
                                                key={book.isbn}
                                                onClick={() => setSelectedBook(book)}
                                                style={{
                                                    display: 'flex',
                                                    gap: '1rem',
                                                    padding: '1rem',
                                                    border: selectedBook?.isbn === book.isbn ? '2px solid #FF69B4' : '1px solid #eee',
                                                    borderRadius: '8px',
                                                    marginBottom: '0.5rem',
                                                    cursor: 'pointer',
                                                    background: selectedBook?.isbn === book.isbn ? '#FFE4E1' : 'white'
                                                }}
                                            >
                                                {book.cover && (
                                                    <img 
                                                        src={book.cover} 
                                                        alt={book.title}
                                                        style={{
                                                            width: '60px',
                                                            height: '90px',
                                                            objectFit: 'cover',
                                                            borderRadius: '6px'
                                                        }}
                                                    />
                                                )}
                                                <div style={{ flex: 1 }}>
                                                    <h4 style={{ marginBottom: '0.25rem', fontSize: '0.95rem' }}>{book.title}</h4>
                                                    <p style={{ fontSize: '0.85rem', color: '#666' }}>
                                                        {book.author} | {book.publisher}
                                                    </p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </>
                        ) : (
                            <div style={{
                                padding: '1rem',
                                background: '#F8F9FA',
                                borderRadius: '10px',
                                marginBottom: '1.5rem'
                            }}>
                                <p style={{ marginBottom: '0.5rem', fontWeight: 'bold' }}>ÏÑ†ÌÉùÌïú Ï±Ö:</p>
                                <p style={{ marginBottom: '0.25rem' }}>{selectedBook.title}</p>
                                <p style={{ fontSize: '0.9rem', color: '#666' }}>
                                    {selectedBook.author} | {selectedBook.publisher}
                                </p>
                                <button
                                    onClick={() => setSelectedBook(null)}
                                    style={{
                                        marginTop: '0.5rem',
                                        padding: '0.25rem 0.75rem',
                                        background: 'white',
                                        border: '1px solid #ddd',
                                        borderRadius: '6px',
                                        fontSize: '0.85rem',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Îã§Ïãú ÏÑ†ÌÉù
                                </button>
                            </div>
                        )}

                        <div style={{ display: 'flex', gap: '1rem' }}>
                            <button
                                onClick={handleConfirm}
                                disabled={loading || !selectedBook}
                                style={{
                                    flex: 1,
                                    padding: '0.75rem',
                                    background: loading || !selectedBook ? '#ccc' : '#FF69B4',
                                    border: 'none',
                                    borderRadius: '10px',
                                    color: 'white',
                                    fontSize: '1rem',
                                    fontWeight: 'bold',
                                    cursor: loading || !selectedBook ? 'not-allowed' : 'pointer'
                                }}
                            >
                                {loading ? '‚è≥ Ï∂îÍ∞Ä Ï§ë...' : '‚úÖ Ï∂îÍ∞ÄÌïòÍ∏∞'}
                            </button>
                            
                            <button
                                onClick={handleClose}
                                disabled={loading}
                                style={{
                                    flex: 1,
                                    padding: '0.75rem',
                                    background: 'white',
                                    border: '2px solid #FFB6C1',
                                    borderRadius: '10px',
                                    color: '#FF69B4',
                                    fontSize: '1rem',
                                    cursor: loading ? 'not-allowed' : 'pointer'
                                }}
                            >
                                Ï∑®ÏÜå
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function Section({ title, subtitle, children }) {
            return (
                <div style={{
                    marginBottom: '2rem',
                    background: 'rgba(255,255,255,0.5)',
                    borderRadius: '20px',
                    padding: '1.5rem'
                }}>
                    <div style={{ marginBottom: '1rem' }}>
                        <h2 style={{ fontSize: '1.5rem', color: '#333', marginBottom: '0.25rem' }}>
                            {title}
                        </h2>
                        {subtitle && (
                            <p style={{ fontSize: '0.9rem', color: '#666' }}>{subtitle}</p>
                        )}
                    </div>
                    {children}
                </div>
            );
        }

        function StatCard({ icon, label, value, color }) {
            return (
                <div style={{
                    background: 'white',
                    borderRadius: '15px',
                    padding: '1.5rem',
                    textAlign: 'center',
                    border: `3px solid ${color}`,
                    transition: 'transform 0.3s',
                    cursor: label !== 'Ï†ÑÏ≤¥' ? 'pointer' : 'default'
                }}
                onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-5px)'}
                onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}
                >
                    <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>{icon}</div>
                    <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#333' }}>{value}</div>
                    <div style={{ fontSize: '0.9rem', color: '#666' }}>{label}</div>
                </div>
            );
        }

        function CollectionCard({ name, count, onClick }) {
            const [hover, setHover] = useState(false);
            
            return (
                <div
                    onClick={onClick}
                    onMouseEnter={() => setHover(true)}
                    onMouseLeave={() => setHover(false)}
                    style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: '1.5rem',
                        cursor: 'pointer',
                        border: '2px solid #FFB6C1',
                        transition: 'all 0.3s',
                        transform: hover ? 'translateY(-5px)' : 'translateY(0)',
                        boxShadow: hover ? '0 8px 16px rgba(0,0,0,0.1)' : '0 2px 8px rgba(0,0,0,0.05)'
                    }}
                >
                    <h3 style={{
                        fontSize: '1.1rem',
                        color: '#333',
                        marginBottom: '0.5rem'
                    }}>
                        {name}
                    </h3>
                    <p style={{ fontSize: '0.9rem', color: '#FF69B4', fontWeight: 'bold' }}>
                        {count}Í∂å
                    </p>
                </div>
            );
        }

        function BookCard({ book, log, onClick, compact }) {
            const [hover, setHover] = useState(false);
            const isRead = !!log;
            const reaction = log?.fields['ÏïÑÏù¥Î∞òÏùë'];
            const coverImage = book.fields['ÌëúÏßÄÏù¥ÎØ∏ÏßÄ'];
            
            return (
                <div
                    onMouseEnter={() => setHover(true)}
                    onMouseLeave={() => setHover(false)}
                    style={{
                        background: 'white',
                        borderRadius: '15px',
                        padding: compact ? '1rem' : '1.5rem',
                        cursor: 'pointer',
                        border: isRead ? '2px solid #98D8C8' : '2px solid #FFB6C1',
                        transition: 'all 0.3s',
                        transform: hover ? 'translateY(-5px)' : 'translateY(0)',
                        boxShadow: hover ? '0 8px 16px rgba(0,0,0,0.1)' : '0 2px 8px rgba(0,0,0,0.05)',
                        position: 'relative'
                    }}
                >
                    {isRead && (
                        <div style={{
                            position: 'absolute',
                            top: '0.5rem',
                            right: '0.5rem',
                            fontSize: '1.5rem'
                        }}>
                            {reaction || '‚úÖ'}
                        </div>
                    )}
                    
                    <div onClick={onClick}>
                        {/* ÌëúÏßÄ Ïù¥ÎØ∏ÏßÄ */}
                        {coverImage && (
                            <div style={{
                                width: '100%',
                                height: compact ? '120px' : '180px',
                                marginBottom: '1rem',
                                borderRadius: '10px',
                                overflow: 'hidden',
                                background: '#f5f5f5'
                            }}>
                                <img 
                                    src={coverImage} 
                                    alt={book.fields['Ï†úÎ™©']}
                                    style={{
                                        width: '100%',
                                        height: '100%',
                                        objectFit: 'cover'
                                    }}
                                    onError={(e) => {
                                        e.target.style.display = 'none';
                                    }}
                                />
                            </div>
                        )}
                        
                        <h3 style={{
                            fontSize: compact ? '1rem' : '1.2rem',
                            color: '#333',
                            marginBottom: '0.5rem',
                            lineHeight: '1.4',
                            paddingRight: isRead ? '2rem' : '0'
                        }}>
                            {book.fields['Ï†úÎ™©']}
                        </h3>
                        
                        <p style={{ fontSize: '0.85rem', color: '#666', marginBottom: '0.5rem' }}>
                            {book.fields['Ï†ÄÏûê']}
                            {book.fields['Ï∂úÌåêÏÇ¨'] && ` ¬∑ ${book.fields['Ï∂úÌåêÏÇ¨']}`}
                        </p>
                        
                        {book.fields['Ï†ÑÏßëÎ™Ö'] && (
                            <p style={{ 
                                fontSize: '0.8rem', 
                                color: '#FF69B4', 
                                marginBottom: '0.5rem',
                                fontWeight: 'bold'
                            }}>
                                üìö {book.fields['Ï†ÑÏßëÎ™Ö']}
                            </p>
                        )}
                        
                        {book.fields['ÌÖåÎßà'] && !compact && (
                            <div style={{ marginTop: '0.75rem', display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                {book.fields['ÌÖåÎßà'].split(',').slice(0, 3).map((tema, idx) => (
                                    <span key={idx} style={{
                                        background: '#FFE4E1',
                                        color: '#FF69B4',
                                        padding: '0.25rem 0.75rem',
                                        borderRadius: '20px',
                                        fontSize: '0.7rem'
                                    }}>
                                        {tema.trim()}
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function CollectionView({ collections, books, onBack, onSelectBook }) {
            const [selectedCol, setSelectedCol] = useState(collections[0]?.name);
            const filteredBooks = books.filter(b => b.fields['Ï†ÑÏßëÎ™Ö'] === selectedCol);

            return (
                <div>

                    <h2 style={{ fontSize: '2rem', color: '#FF69B4', marginBottom: '1rem' }}>
                        üìö Ï†ÑÏßë ÎëòÎü¨Î≥¥Í∏∞
                    </h2>

                    {/* Ï†ÑÏßë ÌÉ≠ */}
                    <div style={{
                        display: 'flex',
                        flexWrap: 'wrap',
                        gap: '0.5rem',
                        marginBottom: '2rem'
                    }}>
                        {collections.map(col => (
                            <button
                                key={col.name}
                                onClick={() => setSelectedCol(col.name)}
                                style={{
                                    padding: '0.75rem 1.5rem',
                                    background: selectedCol === col.name ? '#FF69B4' : 'white',
                                    border: '2px solid #FFB6C1',
                                    borderRadius: '10px',
                                    color: selectedCol === col.name ? 'white' : '#FF69B4',
                                    cursor: 'pointer',
                                    fontSize: '0.9rem',
                                    fontWeight: selectedCol === col.name ? 'bold' : 'normal'
                                }}
                            >
                                {col.name} ({col.count})
                            </button>
                        ))}
                    </div>

                    {/* Ï±Ö Í∑∏Î¶¨Îìú */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
                        gap: '1.5rem'
                    }}>
                        {filteredBooks.map(book => (
                            <BookCard
                                key={book.id}
                                book={book}
                                onClick={() => onSelectBook(book)}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        function ThemeView({ theme, books, onBack, onSelectBook }) {
            return (
                <div>

                    <h2 style={{ fontSize: '2rem', color: '#FF69B4', marginBottom: '1rem' }}>
                        üîç #{theme} ({books.length}Í∂å)
                    </h2>

                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
                        gap: '1.5rem'
                    }}>
                        {books.map(book => (
                            <BookCard
                                key={book.id}
                                book={book}
                                onClick={() => onSelectBook(book)}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        function FilterView({ filterType, books, readingLogs, onBack, onSelectBook, setShowSearchModal }) {
            const filterInfo = {
                'read': { title: '‚úÖ ÏùΩÏùÄ Ï±Ö', icon: '‚úÖ', color: '#98D8C8' },
                'loved': { title: 'üòç ÏµúÏï† Ï±Ö', icon: 'üòç', color: '#FFB347' },
                'interested': { title: 'üí° Í¥ÄÏã¨ ÏûàÎäî Ï±Ö', icon: 'üí°', color: '#DDA0DD' }
            };
            
            const info = filterInfo[filterType];
            
            // ÌïÑÌÑ∞ÎßÅ
            let filteredBooks = [];
            if (filterType === 'read') {
                // ÏùΩÍ∏∞ Í∏∞Î°ùÏù¥ ÏûàÎäî Ï±ÖÎßå (Í¥ÄÏã¨ Ïó¨Î∂ÄÏôÄ Î¨¥Í¥Ä)
                filteredBooks = books.filter(book => {
                    // ÏùΩÍ∏∞ Í∏∞Î°ùÏù¥ ÏûàÎäîÏßÄÎßå ÌôïÏù∏
                    const log = readingLogs.find(log => log.fields['Ï±Ö']?.[0] === book.id);
                    return !!log; // ÏùΩÍ∏∞ Í∏∞Î°ùÏù¥ ÏûàÏúºÎ©¥ ÌëúÏãú
                });
            } else if (filterType === 'loved') {
                // üòç Î∞òÏùëÏù¥ ÏûàÎäî Ï±ÖÎßå
                filteredBooks = books.filter(book => {
                    const log = readingLogs.find(log => log.fields['Ï±Ö']?.[0] === book.id);
                    return log && log.fields['ÏïÑÏù¥Î∞òÏùë'] === 'üòç';
                });
            } else if (filterType === 'interested') {
                // Í¥ÄÏã¨ ÏûàÎäî Ï±Ö (Í¥ÄÏã¨ ÌïÑÎìúÍ∞Ä trueÏù∏ Ï±ÖÎßå, ÏùΩÍ∏∞ Í∏∞Î°ù Ïó¨Î∂ÄÏôÄ Î¨¥Í¥Ä)
                filteredBooks = books.filter(book => {
                    // Í¥ÄÏã¨ ÌïÑÎìúÍ∞Ä trueÏù∏ Ï±ÖÎßå ÌëúÏãú
                    const isInterested = book.fields['Í¥ÄÏã¨'] === true || book.fields['Í¥ÄÏã¨'] === 'true';
                    return isInterested; // Í¥ÄÏã¨ ÌïÑÎìúÎßå ÌôïÏù∏, ÏùΩÍ∏∞ Í∏∞Î°ù Ïó¨Î∂Ä Î¨¥Ïãú
                });
            }
            
            return (
                <div>
                    <h2 style={{ fontSize: '2rem', color: '#FF69B4', marginBottom: '1rem' }}>
                        {info.title} ({filteredBooks.length}Í∂å)
                    </h2>

                    {/* Í¥ÄÏã¨ ÏûàÎäî Ï±Ö ÌÉ≠ÏóêÎßå Í≤ÄÏÉâ Î≤ÑÌäº ÌëúÏãú */}
                    {filterType === 'interested' && (
                        <button
                            onClick={() => setShowSearchModal(true)}
                            style={{
                                padding: '0.75rem 1.5rem',
                                marginBottom: '1.5rem',
                                background: '#FF69B4',
                                border: 'none',
                                borderRadius: '25px',
                                color: 'white',
                                fontSize: '1rem',
                                fontWeight: 'bold',
                                cursor: 'pointer'
                            }}
                        >
                            ‚ûï ÏÉà Ï±Ö Í≤ÄÏÉâÌïòÍ∏∞
                        </button>
                    )}

                    {filteredBooks.length === 0 ? (
                        <div style={{
                            textAlign: 'center',
                            padding: '3rem',
                            background: 'white',
                            borderRadius: '15px',
                            color: '#999'
                        }}>
                            <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üìö</div>
                            <p>ÏïÑÏßÅ ÏóÜÏñ¥Ïöî!</p>
                        </div>
                    ) : (
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
                            gap: '1.5rem'
                        }}>
                            {filteredBooks.map(book => {
                                const log = readingLogs.find(l => l.fields['Ï±Ö']?.[0] === book.id);
                                const hasGuide = book.fields['Î∂ÄÎ™®_ÏùΩÍ∏∞_Í∞ÄÏù¥Îìú'] && book.fields['Î∂ÄÎ™®_ÏùΩÍ∏∞_Í∞ÄÏù¥Îìú'].trim();
                                
                                return (
                                    <div key={book.id} style={{ position: 'relative' }}>
                                        <BookCard
                                            book={book}
                                            log={log}
                                            onClick={() => onSelectBook(book)}
                                        />
                                        {/* Í¥ÄÏã¨Ï±ÖÏù¥Í≥† Í∞ÄÏù¥ÎìúÍ∞Ä ÏóÜÏúºÎ©¥ Í∞ÄÏù¥Îìú ÏÉùÏÑ± Î≤ÑÌäº */}
                                        {filterType === 'interested' && !hasGuide && (
                                            <button
                                                onClick={async (e) => {
                                                    e.stopPropagation();
                                                    if (!confirm('Ïù¥ Ï±ÖÏùò Î∂ÄÎ™® Í∞ÄÏù¥ÎìúÎ•º ÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(AI Í∞ÄÏù¥Îìú ÏÉùÏÑ±Ïóê ÏãúÍ∞ÑÏù¥ Í±∏Î¶ΩÎãàÎã§)')) {
                                                        return;
                                                    }
                                                    
                                                    try {
                                                        const response = await fetch('/api/update-book-guide', {
                                                            method: 'POST',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({
                                                                bookId: book.id,
                                                                title: book.fields['Ï†úÎ™©'],
                                                                author: book.fields['Ï†ÄÏûê']
                                                            })
                                                        });
                                                        
                                                        const data = await response.json();
                                                        
                                                        if (data.success) {
                                                            alert('Î∂ÄÎ™® Í∞ÄÏù¥ÎìúÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!');
                                                            await loadData();
                                                        } else {
                                                            alert('Í∞ÄÏù¥Îìú ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                                                        }
                                                    } catch (error) {
                                                        console.error('Í∞ÄÏù¥Îìú ÏÉùÏÑ± Ïò§Î•ò:', error);
                                                        alert('Í∞ÄÏù¥Îìú ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
                                                    }
                                                }}
                                                style={{
                                                    position: 'absolute',
                                                    top: '0.5rem',
                                                    right: '0.5rem',
                                                    padding: '0.5rem 1rem',
                                                    background: '#FF69B4',
                                                    border: 'none',
                                                    borderRadius: '8px',
                                                    color: 'white',
                                                    fontSize: '0.85rem',
                                                    fontWeight: 'bold',
                                                    cursor: 'pointer',
                                                    zIndex: 10,
                                                    boxShadow: '0 2px 8px rgba(0,0,0,0.2)'
                                                }}
                                            >
                                                ü§ñ Í∞ÄÏù¥Îìú ÏÉùÏÑ±
                                            </button>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        }

        function AllBooksView({ books, readingLogs, onBack, onSelectBook, initialSearchTerm = '' }) {
            const [searchTerm, setSearchTerm] = useState(initialSearchTerm);
            const [sortBy, setSortBy] = useState('title');
            const [currentPage, setCurrentPage] = useState(1);
            const BOOKS_PER_PAGE = 24;

            // initialSearchTermÏù¥ ÏûàÏúºÎ©¥ Í≤ÄÏÉâÏñ¥ ÌïÑÌÑ∞ÎßÅ, ÏóÜÏúºÎ©¥ Ï†ÑÏ≤¥ Ï±Ö
            const filteredBooks = initialSearchTerm 
                ? books.filter(book =>
                    book.fields['Ï†úÎ™©']?.toLowerCase().includes(initialSearchTerm.toLowerCase()) ||
                    book.fields['Ï†ÄÏûê']?.toLowerCase().includes(initialSearchTerm.toLowerCase()) ||
                    book.fields['ÌÖåÎßà']?.toLowerCase().includes(initialSearchTerm.toLowerCase())
                  )
                : books.filter(book =>
                    !searchTerm || 
                    book.fields['Ï†úÎ™©']?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    book.fields['Ï†ÄÏûê']?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    book.fields['ÌÖåÎßà']?.toLowerCase().includes(searchTerm.toLowerCase())
                  );

            const sortedBooks = [...filteredBooks].sort((a, b) => {
                if (sortBy === 'title') return (a.fields['Ï†úÎ™©'] || '').localeCompare(b.fields['Ï†úÎ™©'] || '');
                if (sortBy === 'author') return (a.fields['Ï†ÄÏûê'] || '').localeCompare(b.fields['Ï†ÄÏûê'] || '');
                return 0;
            });

            const totalPages = Math.ceil(sortedBooks.length / BOOKS_PER_PAGE);
            const startIdx = (currentPage - 1) * BOOKS_PER_PAGE;
            const paginatedBooks = sortedBooks.slice(startIdx, startIdx + BOOKS_PER_PAGE);

            return (
                <div>

                    <h2 style={{ fontSize: '2rem', color: '#FF69B4', marginBottom: '1rem' }}>
                        {initialSearchTerm ? `üîç Í≤ÄÏÉâ Í≤∞Í≥º: "${initialSearchTerm}" (${filteredBooks.length}Í∂å)` : `üìö Ï†ÑÏ≤¥ ÎèÑÏÑú (${books.length}Í∂å)`}
                    </h2>

                    {/* Í≤ÄÏÉâ & Ï†ïÎ†¨ */}
                    <div style={{
                        display: 'flex',
                        gap: '1rem',
                        marginBottom: '1.5rem',
                        flexWrap: 'wrap'
                    }}>
                        <input
                            type="text"
                            placeholder="Ï†úÎ™©, Ï†ÄÏûê, ÌÖåÎßàÎ°ú Í≤ÄÏÉâ..."
                            value={searchTerm}
                            onChange={(e) => {
                                setSearchTerm(e.target.value);
                                setCurrentPage(1);
                            }}
                            style={{
                                flex: 1,
                                padding: '0.75rem',
                                border: '2px solid #FFB6C1',
                                borderRadius: '10px',
                                fontSize: '1rem'
                            }}
                        />
                        <select
                            value={sortBy}
                            onChange={(e) => setSortBy(e.target.value)}
                            style={{
                                padding: '0.75rem',
                                border: '2px solid #FFB6C1',
                                borderRadius: '10px',
                                fontSize: '1rem',
                                background: 'white'
                            }}
                        >
                            <option value="title">Ï†úÎ™©Ïàú</option>
                            <option value="author">Ï†ÄÏûêÏàú</option>
                        </select>
                    </div>

                    {/* Ï±Ö Í∑∏Î¶¨Îìú */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
                        gap: '1.5rem',
                        marginBottom: '2rem'
                    }}>
                        {paginatedBooks.map(book => {
                            const log = readingLogs.find(l => l.fields['Ï±Ö']?.[0] === book.id);
                            return (
                                <BookCard
                                    key={book.id}
                                    book={book}
                                    log={log}
                                    onClick={() => onSelectBook(book)}
                                />
                            );
                        })}
                    </div>

                    {/* ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò */}
                    {totalPages > 1 && (
                        <div style={{
                            display: 'flex',
                            justifyContent: 'center',
                            gap: '0.5rem',
                            flexWrap: 'wrap'
                        }}>
                            <button
                                onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                                disabled={currentPage === 1}
                                style={{
                                    padding: '0.5rem 1rem',
                                    background: currentPage === 1 ? '#eee' : '#FF69B4',
                                    border: 'none',
                                    borderRadius: '8px',
                                    color: 'white',
                                    cursor: currentPage === 1 ? 'not-allowed' : 'pointer'
                                }}
                            >
                                ‚Üê
                            </button>
                            
                            {/* ÌéòÏù¥ÏßÄ Î≤àÌò∏ Ï†úÌïú (ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Í∏∞Ï§Ä ÏïûÎí§ 2ÌéòÏù¥ÏßÄÎßå ÌëúÏãú) */}
                            {(() => {
                                const pages = [];
                                const maxVisible = 5; // ÏµúÎåÄ 5Í∞ú ÌéòÏù¥ÏßÄ Î≤àÌò∏ ÌëúÏãú
                                let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
                                let endPage = Math.min(totalPages, startPage + maxVisible - 1);
                                
                                // ÎÅùÏóê Í∞ÄÍπåÏö∞Î©¥ ÏãúÏûëÏ†ê Ï°∞Ï†ï
                                if (endPage - startPage < maxVisible - 1) {
                                    startPage = Math.max(1, endPage - maxVisible + 1);
                                }
                                
                                // Ï≤´ ÌéòÏù¥ÏßÄÍ∞Ä 1Ïù¥ ÏïÑÎãàÎ©¥ ... ÌëúÏãú
                                if (startPage > 1) {
                                    pages.push(
                                        <button
                                            key={1}
                                            onClick={() => setCurrentPage(1)}
                                            style={{
                                                padding: '0.5rem 1rem',
                                                background: 'white',
                                                border: '2px solid #FFB6C1',
                                                borderRadius: '8px',
                                                color: '#FF69B4',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            1
                                        </button>
                                    );
                                    if (startPage > 2) {
                                        pages.push(<span key="ellipsis1" style={{ padding: '0.5rem' }}>...</span>);
                                    }
                                }
                                
                                // ÌéòÏù¥ÏßÄ Î≤àÌò∏Îì§
                                for (let i = startPage; i <= endPage; i++) {
                                    pages.push(
                                        <button
                                            key={i}
                                            onClick={() => setCurrentPage(i)}
                                            style={{
                                                padding: '0.5rem 1rem',
                                                background: currentPage === i ? '#FF69B4' : 'white',
                                                border: '2px solid #FFB6C1',
                                                borderRadius: '8px',
                                                color: currentPage === i ? 'white' : '#FF69B4',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            {i}
                                        </button>
                                    );
                                }
                                
                                // ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄÍ∞Ä ÌëúÏãú Î≤îÏúÑ Î∞ñÏù¥Î©¥ ... ÌëúÏãú
                                if (endPage < totalPages) {
                                    if (endPage < totalPages - 1) {
                                        pages.push(<span key="ellipsis2" style={{ padding: '0.5rem' }}>...</span>);
                                    }
                                    pages.push(
                                        <button
                                            key={totalPages}
                                            onClick={() => setCurrentPage(totalPages)}
                                            style={{
                                                padding: '0.5rem 1rem',
                                                background: 'white',
                                                border: '2px solid #FFB6C1',
                                                borderRadius: '8px',
                                                color: '#FF69B4',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            {totalPages}
                                        </button>
                                    );
                                }
                                
                                return pages;
                            })()}
                            
                            <button
                                onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                                disabled={currentPage === totalPages}
                                style={{
                                    padding: '0.5rem 1rem',
                                    background: currentPage === totalPages ? '#eee' : '#FF69B4',
                                    border: 'none',
                                    borderRadius: '8px',
                                    color: 'white',
                                    cursor: currentPage === totalPages ? 'not-allowed' : 'pointer'
                                }}
                            >
                                ‚Üí
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        function BookDetailModal({ book, log, onClose, updateReadingLog, onDataUpdate }) {
            const [reaction, setReaction] = useState(log?.fields['ÏïÑÏù¥Î∞òÏùë'] || '');
            const [memo, setMemo] = useState(log?.fields['Î©îÎ™®'] || '');
            const [isRead, setIsRead] = useState(!!log?.fields['ÏôÑÎèÖÏó¨Î∂Ä']); // ÎÅùÍπåÏßÄ ÏùΩÏóàÎäîÏßÄ (Ï≤¥ÌÅ¨ÌïòÎ©¥ ÏôÑÎèÖ, ÏïàÌïòÎ©¥ Ï§ëÍ∞ÑÏóê Î©àÏ∂§)
            const [questionLevel, setQuestionLevel] = useState(log?.fields['ÏßàÎ¨∏Ï†ïÎèÑ'] || ''); // 'ÎßéÏùå', 'Î≥¥ÌÜµ', 'ÏóÜÏùå'
            const [focusLevel, setFocusLevel] = useState(log?.fields['ÏßëÏ§ëÏ†ïÎèÑ'] || ''); // 'ÎÜíÏùå', 'Î≥¥ÌÜµ', 'ÎÇÆÏùå'
            const [saving, setSaving] = useState(false);
            const [justSaved, setJustSaved] = useState(false);
            const [libraryLoading, setLibraryLoading] = useState(false);
            const [libraryResults, setLibraryResults] = useState(null);
            const [libraryError, setLibraryError] = useState('');
            const [isLibraryOpen, setIsLibraryOpen] = useState(false);
            
            // Í¥ÄÏã¨Ï±Ö ÏÉÅÌÉú ÌôïÏù∏ (AirtableÏóêÏÑú)
            const isInterested = book.fields['Í¥ÄÏã¨'] === true || book.fields['Í¥ÄÏã¨'] === 'true';
            const [isInInterested, setIsInInterested] = useState(isInterested);

            const reactions = ['üòç', 'üòä', 'üòê', 'üò¢', 'ü•±'];
            
            const handleToggleInterested = async () => {
                try {
                    // AirtableÏóê Í¥ÄÏã¨ Ïó¨Î∂Ä Ï†ÄÏû•
                    const response = await fetch('/api/update-book-field', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            recordId: book.id,
                            fields: {
                                'Í¥ÄÏã¨': !isInInterested
                            }
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        setIsInInterested(!isInInterested);
                        alert(!isInInterested ? 'Í¥ÄÏã¨Ï±ÖÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!' : 'Í¥ÄÏã¨Ï±ÖÏóêÏÑú Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§.');
                        // Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
                        if (onDataUpdate) {
                            await onDataUpdate();
                        }
                    } else {
                        alert('Ïò§Î•ò: ' + (data.error || 'Ï†ÄÏû• Ïã§Ìå®'));
                    }
                } catch (error) {
                    console.error('Í¥ÄÏã¨Ï±Ö Ï†ÄÏû• Ïò§Î•ò:', error);
                    alert('Í¥ÄÏã¨Ï±Ö Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
                }
            };

            const handleSave = async () => {
                setSaving(true);
                setJustSaved(false);
                
                const logData = {
                    'ÏïÑÏù¥Î∞òÏùë': reaction,
                    'Î©îÎ™®': memo,
                    'ÏôÑÎèÖÏó¨Î∂Ä': isRead, // ÎÅùÍπåÏßÄ ÏùΩÏóàÏúºÎ©¥ true, Ï§ëÍ∞ÑÏóê Î©àÏ∑ÑÏúºÎ©¥ false
                    'ÏßàÎ¨∏Ï†ïÎèÑ': questionLevel,
                    'ÏßëÏ§ëÏ†ïÎèÑ': focusLevel
                    // ÎÇ†Ïßú ÌïÑÎìúÎäî AirtableÏóê ÏóÜÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú Ï†úÍ±∞
                };

                const success = await updateReadingLog(book.id, logData);
                
                setSaving(false);
                
                if (success) {
                    setJustSaved(true);
                    // 3Ï¥à ÌõÑ Ï†ÄÏû• ÏôÑÎ£å ÌëúÏãú Ï†úÍ±∞
                    setTimeout(() => setJustSaved(false), 3000);
                } else {
                    alert('‚ùå Ï†ÄÏû• Ïã§Ìå®ÌñàÏñ¥Ïöî. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî!');
                }
            };

            useEffect(() => {
                setLibraryResults(null);
                setLibraryError('');
                setLibraryLoading(false);
                setIsLibraryOpen(false);
            }, [book?.id]);

            const handleCheckLibrary = async () => {
                const isbn = book.fields['ISBN'];
                if (!isbn) {
                    alert('ISBN Ï†ïÎ≥¥Í∞Ä ÏóÜÏñ¥ Ï°∞ÌöåÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }
                setLibraryLoading(true);
                setLibraryError('');
                try {
                    const response = await fetch(`/api/check-book-library?isbn=${encodeURIComponent(isbn)}`);
                    const data = await response.json();
                    if (data.success) {
                        setLibraryResults(data.results || []);
                    } else {
                        setLibraryError(data.error || 'Ï°∞ÌöåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§');
                    }
                } catch (error) {
                    console.error('ÎèÑÏÑúÍ¥Ä Ï°∞Ìöå Ïò§Î•ò:', error);
                    setLibraryError('ÎèÑÏÑúÍ¥Ä Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
                } finally {
                    setLibraryLoading(false);
                }
            };

            const handleToggleLibrary = async () => {
                if (isLibraryOpen) {
                    setIsLibraryOpen(false);
                    return;
                }
                setIsLibraryOpen(true);
                if (!libraryResults && !libraryLoading) {
                    await handleCheckLibrary();
                }
            };

            return (
                <div onClick={onClose} style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: '1rem'
                }}>
                    <div onClick={(e) => e.stopPropagation()} style={{
                        background: 'white',
                        borderRadius: '20px',
                        padding: '2rem',
                        maxWidth: '600px',
                        width: '100%',
                        maxHeight: '90vh',
                        overflow: 'auto'
                    }}>
                        {/* ÌëúÏßÄ Ïù¥ÎØ∏ÏßÄ */}
                        {book.fields['ÌëúÏßÄÏù¥ÎØ∏ÏßÄ'] && (
                            <div style={{
                                width: '200px',
                                height: '280px',
                                margin: '0 auto 1.5rem',
                                borderRadius: '15px',
                                overflow: 'hidden',
                                boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
                            }}>
                                <img 
                                    src={book.fields['ÌëúÏßÄÏù¥ÎØ∏ÏßÄ']} 
                                    alt={book.fields['Ï†úÎ™©']}
                                    style={{
                                        width: '100%',
                                        height: '100%',
                                        objectFit: 'cover'
                                    }}
                                    onError={(e) => {
                                        e.target.parentElement.style.display = 'none';
                                    }}
                                />
                            </div>
                        )}
                        
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '1rem' }}>
                            <h2 style={{ fontSize: '1.8rem', color: '#FF69B4', margin: 0, flex: 1 }}>
                                {book.fields['Ï†úÎ™©']}
                            </h2>
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    handleToggleInterested();
                                }}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    fontSize: '2rem',
                                    cursor: 'pointer',
                                    padding: '0.5rem',
                                    marginLeft: '1rem',
                                    transition: 'transform 0.2s',
                                    lineHeight: 1
                                }}
                                onMouseEnter={(e) => e.target.style.transform = 'scale(1.1)'}
                                onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                                title={isInInterested ? 'Í¥ÄÏã¨Ï±ÖÏóêÏÑú Ï†úÍ±∞' : 'Í¥ÄÏã¨Ï±ÖÏóê Ï∂îÍ∞Ä'}
                            >
                                {isInInterested ? '‚ù§Ô∏è' : 'ü§ç'}
                            </button>
                        </div>
                        
                        {/* ÏÑúÏßÄ Ï†ïÎ≥¥ - 2Ïó¥ Íµ¨ÏÑ± */}
                        <div style={{ 
                            background: '#F8F9FA', 
                            padding: '1rem', 
                            borderRadius: '10px', 
                            marginBottom: '1rem',
                            fontSize: '0.9rem',
                            color: '#666'
                        }}>
                            <div style={{ 
                                display: 'grid', 
                                gridTemplateColumns: '1fr 1fr', 
                                gap: '0.75rem'
                            }}>
                                <div>
                                    <p style={{ marginBottom: '0.5rem' }}>
                                        ‚úçÔ∏è <strong>Ï†ÄÏûê:</strong> {book.fields['Ï†ÄÏûê']}
                                    </p>
                                    
                                    {book.fields['Ï∂úÌåêÏÇ¨'] && (
                                        <p style={{ marginBottom: '0.5rem' }}>
                                            üè¢ <strong>Ï∂úÌåêÏÇ¨:</strong> {book.fields['Ï∂úÌåêÏÇ¨']}
                                        </p>
                                    )}
                                    
                                    {book.fields['Î∞úÌñâÎÖÑ'] && (
                                        <p style={{ marginBottom: '0.5rem' }}>
                                            üìÖ <strong>Î∞úÌñâÎÖÑ:</strong> {book.fields['Î∞úÌñâÎÖÑ']}ÎÖÑ
                                        </p>
                                    )}
                                </div>
                                
                                <div>
                                    {book.fields['Ïó∞Î†π'] && (
                                        <p style={{ marginBottom: '0.5rem' }}>
                                            üë∂ <strong>Ï∂îÏ≤ú Ïó∞Î†π:</strong> {book.fields['Ïó∞Î†π']}
                                        </p>
                                    )}
                                    
                                    {book.fields['ISBN'] && (
                                        <p style={{ marginBottom: '0' }}>
                                            üìö <strong>ISBN:</strong> {book.fields['ISBN']}
                                        </p>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Î∂ÄÏ≤úÏãú ÎèÑÏÑúÍ¥Ä Î≥¥Ïú† Ïó¨Î∂Ä */}
                        {book.fields['ISBN'] && (
                            <div style={{ marginBottom: '1rem' }}>
                                <button
                                    onClick={handleToggleLibrary}
                                    disabled={libraryLoading && !isLibraryOpen}
                                    style={{
                                        width: '100%',
                                        padding: '0.75rem',
                                        background: libraryLoading ? '#ccc' : '#8B7EC8',
                                        border: 'none',
                                        borderRadius: '10px',
                                        color: 'white',
                                        fontSize: '0.95rem',
                                        fontWeight: 'bold',
                                        cursor: libraryLoading ? 'not-allowed' : 'pointer'
                                    }}
                                >
                                    {libraryLoading
                                        ? 'ÎèÑÏÑúÍ¥Ä Ï°∞Ìöå Ï§ë...'
                                        : (isLibraryOpen ? 'üèõÔ∏è ÎèÑÏÑúÍ¥Ä Ï°∞Ìöå Í≤∞Í≥º Îã´Í∏∞' : 'üèõÔ∏è Î∂ÄÏ≤úÏãú ÎèÑÏÑúÍ¥Ä Î≥¥Ïú† Ïó¨Î∂Ä Ï°∞Ìöå')}
                                </button>

                                {libraryError && (
                                    <div style={{ marginTop: '0.5rem', color: '#ff6b6b', fontSize: '0.85rem' }}>
                                        {libraryError}
                                    </div>
                                )}

                                {isLibraryOpen && (
                                    <div style={{
                                        marginTop: '0.75rem',
                                        background: '#F8F9FA',
                                        borderRadius: '10px',
                                        padding: '0.75rem',
                                        fontSize: '0.85rem',
                                        color: '#555'
                                    }}>
                                        <div style={{ marginBottom: '0.5rem', fontWeight: 'bold', color: '#8B7EC8' }}>
                                            Î≥¥Ïú† ÎèÑÏÑúÍ¥Ä
                                        </div>
                                        {libraryLoading && (
                                            <div>Ï°∞Ìöå Ï§ë...</div>
                                        )}
                                        {!libraryLoading && libraryResults && (
                                            libraryResults.filter(r => r.hasBook).length === 0 ? (
                                                <div>Î≥¥Ïú† ÎèÑÏÑúÍ¥ÄÏù¥ ÏóÜÏäµÎãàÎã§.</div>
                                            ) : (
                                                <div style={{ display: 'grid', gap: '0.35rem' }}>
                                                    {libraryResults.filter(r => r.hasBook).map(lib => (
                                                        <div key={lib.libCode} style={{ display: 'flex', justifyContent: 'space-between' }}>
                                                            <span>{lib.libName}</span>
                                                            <span style={{ color: lib.loanAvailable ? '#2ecc71' : '#999' }}>
                                                                {lib.loanAvailable ? 'ÎåÄÏ∂ú Í∞ÄÎä•' : 'ÎåÄÏ∂ú Î∂àÍ∞Ä'}
                                                            </span>
                                                        </div>
                                                    ))}
                                                </div>
                                            )
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {book.fields['ÌÖåÎßà'] && (
                            <div style={{ marginBottom: '1rem' }}>
                                <strong>üè∑Ô∏è ÌÖåÎßà:</strong>
                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem', marginTop: '0.5rem' }}>
                                    {book.fields['ÌÖåÎßà'].split(',').map((tema, idx) => (
                                        <span key={idx} style={{
                                            background: '#FFE4E1',
                                            color: '#FF69B4',
                                            padding: '0.25rem 0.75rem',
                                            borderRadius: '20px',
                                            fontSize: '0.85rem'
                                        }}>
                                            {tema.trim()}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )}

                        {book.fields['ÏÑ§Î™Ö'] && (
                            <div style={{
                                marginBottom: '1.5rem',
                                padding: '1rem',
                                background: '#F8F9FA',
                                borderRadius: '10px',
                                lineHeight: '1.6',
                                fontSize: '0.9rem',
                                color: '#333'
                            }}>
                                <strong style={{ display: 'block', marginBottom: '0.5rem', color: '#FF69B4' }}>
                                    üìñ Ï±Ö ÏÜåÍ∞ú
                                </strong>
                                <div style={{ whiteSpace: 'pre-wrap' }}>
                                    {book.fields['ÏÑ§Î™Ö']}
                                </div>
                            </div>
                        )}

                        {book.fields['Î∂ÄÎ™®_ÏùΩÍ∏∞_Í∞ÄÏù¥Îìú'] && (
                            <div style={{
                                background: '#FFF5E1',
                                padding: '1rem',
                                borderRadius: '10px',
                                marginBottom: '1rem'
                            }}>
                                <strong style={{ color: '#FF69B4' }}>üìñ Î∂ÄÎ™® Í∞ÄÏù¥Îìú</strong>
                                <p style={{ marginTop: '0.5rem', lineHeight: '1.6' }}>
                                    {book.fields['Î∂ÄÎ™®_ÏùΩÍ∏∞_Í∞ÄÏù¥Îìú']}
                                </p>
                            </div>
                        )}

                        {book.fields['Ïó∞Í≥ÑÎÜÄÏù¥'] && (
                            <div style={{
                                background: '#E6F7FF',
                                padding: '1rem',
                                borderRadius: '10px',
                                marginBottom: '1rem'
                            }}>
                                <strong style={{ color: '#FF69B4' }}>üé® Ïó∞Í≥ÑÎÜÄÏù¥</strong>
                                <p style={{ marginTop: '0.5rem', lineHeight: '1.6' }}>
                                    {book.fields['Ïó∞Í≥ÑÎÜÄÏù¥']}
                                </p>
                            </div>
                        )}

                        {/* ÏùΩÍ∏∞ Í∏∞Î°ù ÏÑπÏÖò */}
                        <div style={{
                            background: '#F8F9FA',
                            padding: '1.5rem',
                            borderRadius: '15px',
                            marginBottom: '1rem',
                            border: '2px solid #E9ECEF'
                        }}>
                            <h3 style={{ fontSize: '1.2rem', color: '#FF69B4', marginBottom: '1rem' }}>
                                üìù ÏùΩÍ∏∞ Í∏∞Î°ù
                            </h3>

                            {/* ÏôÑÎèÖ Ïó¨Î∂Ä (ÎÅùÍπåÏßÄ ÏùΩÏóàÎäîÏßÄ) */}
                            <div style={{ marginBottom: '1rem' }}>
                                <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                                    <input
                                        type="checkbox"
                                        checked={isRead}
                                        onChange={(e) => setIsRead(e.target.checked)}
                                        style={{ 
                                            width: '20px', 
                                            height: '20px', 
                                            marginRight: '0.5rem',
                                            cursor: 'pointer'
                                        }}
                                    />
                                    <span style={{ fontSize: '1rem' }}>
                                        {isRead ? '‚úÖ ÎÅùÍπåÏßÄ ÏùΩÏóàÏñ¥Ïöî' : '‚è∏Ô∏è Ï§ëÍ∞ÑÏóê Î©àÏ∑ÑÏñ¥Ïöî'}
                                    </span>
                                </label>
                            </div>

                            {/* ÏßàÎ¨∏ Ï†ïÎèÑ */}
                            <div style={{ marginBottom: '1rem' }}>
                                <strong style={{ display: 'block', marginBottom: '0.5rem' }}>ÏßàÎ¨∏Ïù¥ ÎßéÏïòÎÇòÏöî?</strong>
                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                    {['ÎßéÏùå', 'Î≥¥ÌÜµ', 'ÏóÜÏùå'].map(level => (
                                        <button
                                            key={level}
                                            onClick={() => setQuestionLevel(level)}
                                            style={{
                                                flex: 1,
                                                padding: '0.5rem',
                                                border: questionLevel === level ? '3px solid #FF69B4' : '2px solid #ddd',
                                                borderRadius: '10px',
                                                background: questionLevel === level ? '#FFE4E1' : 'white',
                                                cursor: 'pointer',
                                                fontSize: '0.9rem'
                                            }}
                                        >
                                            {level === 'ÎßéÏùå' ? '‚ùì ÎßéÏù¥' : level === 'Î≥¥ÌÜµ' ? 'ü§î Î≥¥ÌÜµ' : 'üòê ÏóÜÏùå'}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* ÏßëÏ§ë Ï†ïÎèÑ */}
                            <div style={{ marginBottom: '1rem' }}>
                                <strong style={{ display: 'block', marginBottom: '0.5rem' }}>ÏßëÏ§ëÌï¥ÏÑú Î¥§ÎÇòÏöî?</strong>
                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                    {['ÎÜíÏùå', 'Î≥¥ÌÜµ', 'ÎÇÆÏùå'].map(level => (
                                        <button
                                            key={level}
                                            onClick={() => setFocusLevel(level)}
                                            style={{
                                                flex: 1,
                                                padding: '0.5rem',
                                                border: focusLevel === level ? '3px solid #FF69B4' : '2px solid #ddd',
                                                borderRadius: '10px',
                                                background: focusLevel === level ? '#FFE4E1' : 'white',
                                                cursor: 'pointer',
                                                fontSize: '0.9rem'
                                            }}
                                        >
                                            {level === 'ÎÜíÏùå' ? 'üéØ ÎÜíÏùå' : level === 'Î≥¥ÌÜµ' ? 'üëÄ Î≥¥ÌÜµ' : 'üò¥ ÎÇÆÏùå'}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* ÏïÑÏù¥ Î∞òÏùë */}
                            <div style={{ marginBottom: '1rem' }}>
                                <strong style={{ display: 'block', marginBottom: '0.5rem' }}>ÏïÑÏù¥ Î∞òÏùë:</strong>
                                <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                    {reactions.map(r => (
                                        <button
                                            key={r}
                                            onClick={() => setReaction(r)}
                                            style={{
                                                fontSize: '2rem',
                                                padding: '0.5rem',
                                                border: reaction === r ? '3px solid #FF69B4' : '2px solid #ddd',
                                                borderRadius: '10px',
                                                background: reaction === r ? '#FFE4E1' : 'white',
                                                cursor: 'pointer',
                                                transition: 'all 0.2s'
                                            }}
                                        >
                                            {r}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Î©îÎ™® */}
                            <div>
                                <strong style={{ display: 'block', marginBottom: '0.5rem' }}>Î©îÎ™®:</strong>
                                <textarea
                                    value={memo}
                                    onChange={(e) => setMemo(e.target.value)}
                                    placeholder="Ï±ÖÏùÑ ÏùΩÏúºÎ©¥ÏÑú ÎäêÎÇÄ Ï†êÏù¥ÎÇò Ïö∞ÎûåÏù¥ Î∞òÏùëÏùÑ Ï†ÅÏñ¥Î≥¥ÏÑ∏Ïöî..."
                                    style={{
                                        width: '100%',
                                        padding: '0.75rem',
                                        border: '2px solid #ddd',
                                        borderRadius: '10px',
                                        fontSize: '0.9rem',
                                        minHeight: '100px',
                                        resize: 'vertical',
                                        outline: 'none'
                                    }}
                                />
                            </div>

                            {/* Ï†ÄÏû• Î≤ÑÌäº */}
                            <button
                                onClick={handleSave}
                                disabled={saving}
                                style={{
                                    width: '100%',
                                    padding: '0.75rem',
                                    marginTop: '1rem',
                                    background: saving ? '#ccc' : (justSaved ? '#98D8C8' : '#FF69B4'),
                                    border: 'none',
                                    borderRadius: '10px',
                                    color: 'white',
                                    fontSize: '1rem',
                                    fontWeight: 'bold',
                                    cursor: saving ? 'not-allowed' : 'pointer',
                                    transition: 'all 0.3s'
                                }}
                            >
                                {saving ? 'üíæ Ï†ÄÏû• Ï§ë...' : (justSaved ? '‚úÖ Ï†ÄÏû• ÏôÑÎ£å!' : 'üíæ Ï†ÄÏû•ÌïòÍ∏∞')}
                            </button>
                            {justSaved && (
                                <p style={{ 
                                    textAlign: 'center', 
                                    marginTop: '0.5rem', 
                                    fontSize: '0.9rem', 
                                    color: '#98D8C8',
                                    fontWeight: 'bold'
                                }}>
                                    Ï†ÄÏû•ÎêòÏóàÏñ¥Ïöî! Í≥ÑÏÜç ÏàòÏ†ïÌïòÍ±∞ÎÇò Îã´Í∏∞Î•º ÎàåÎü¨Ï£ºÏÑ∏Ïöî.
                                </p>
                            )}
                        </div>

                        <button
                            onClick={onClose}
                            style={{
                                width: '100%',
                                padding: '0.75rem',
                                background: 'white',
                                border: '2px solid #FFB6C1',
                                borderRadius: '10px',
                                color: '#FF69B4',
                                fontSize: '1rem',
                                cursor: 'pointer'
                            }}
                        >
                            Îã´Í∏∞
                        </button>
                    </div>
                </div>
            );
        }

        function SettingsView({ profile, onSave }) {
            const [birthDate, setBirthDate] = useState(profile.birthDate || '');
            const [gender, setGender] = useState(profile.gender || '');
            const [booksPerDay, setBooksPerDay] = useState(profile.booksPerDay || 2);
            const [emotionSensitivity, setEmotionSensitivity] = useState(profile.emotionSensitivity || 'normal');
            const [saving, setSaving] = useState(false);
            const computedAgeMonths = computeAgeMonthsFromBirthdate(birthDate);
            const hasComputedAgeMonths = Number.isFinite(computedAgeMonths);

            const handleSave = () => {
                setSaving(true);
                onSave({
                    birthDate,
                    ageMonths: hasComputedAgeMonths ? computedAgeMonths : '',
                    gender,
                    booksPerDay: parseInt(booksPerDay) || 2,
                    emotionSensitivity
                });
                setTimeout(() => {
                    setSaving(false);
                    alert('ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
                }, 300);
            };

            return (
                <div>
                    <h2 style={{ fontSize: '2rem', color: '#FF69B4', marginBottom: '2rem' }}>
                        üë∂ ÏïÑÏù¥ ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï
                    </h2>

                        {/* ÏÉùÎÖÑÏõîÏùº */}
                        <div style={{ marginBottom: '1.5rem' }}>
                            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>
                                ÏÉùÎÖÑÏõîÏùº
                            </label>
                            <input
                                type="date"
                                value={birthDate}
                                onChange={(e) => setBirthDate(e.target.value)}
                                max={new Date().toISOString().split('T')[0]}
                                style={{
                                    width: '100%',
                                    padding: '0.75rem',
                                    border: '2px solid #ddd',
                                    borderRadius: '10px',
                                    fontSize: '1rem',
                                    outline: 'none'
                                }}
                            />
                            <div style={{ marginTop: '0.5rem', fontSize: '0.9rem', color: '#666' }}>
                                {hasComputedAgeMonths
                                    ? `ÌòÑÏû¨ ÏõîÎ†π: ${computedAgeMonths}Í∞úÏõî`
                                    : 'ÏÉùÎÖÑÏõîÏùºÏùÑ ÏûÖÎ†•ÌïòÎ©¥ ÏõîÎ†πÏù¥ ÏûêÎèô Í≥ÑÏÇ∞ÎèºÏöî.'}
                            </div>
                        </div>

                        {/* ÏÑ±Î≥Ñ */}
                        <div style={{ marginBottom: '1.5rem' }}>
                            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>
                                ÏÑ±Î≥Ñ (ÏÑ†ÌÉù)
                            </label>
                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                {['ÎÇ®ÏïÑ', 'Ïó¨ÏïÑ'].map(g => (
                                    <button
                                        key={g}
                                        onClick={() => setGender(g)}
                                        style={{
                                            flex: 1,
                                            padding: '0.75rem',
                                            border: gender === g ? '3px solid #FF69B4' : '2px solid #ddd',
                                            borderRadius: '10px',
                                            background: gender === g ? '#FFE4E1' : 'white',
                                            cursor: 'pointer',
                                            fontSize: '0.9rem'
                                        }}
                                    >
                                        {g}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* ÌïòÎ£®Ïóê ÏùΩÎäî Ï±Ö Í∂åÏàò */}
                        <div style={{ marginBottom: '1.5rem' }}>
                            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>
                                ÌïòÎ£®Ïóê ÏùΩÎäî Ï±Ö Í∂åÏàò
                            </label>
                            <input
                                type="number"
                                value={booksPerDay}
                                onChange={(e) => setBooksPerDay(e.target.value)}
                                placeholder="Ïòà: 2"
                                min="1"
                                max="10"
                                style={{
                                    width: '100%',
                                    padding: '0.75rem',
                                    border: '2px solid #ddd',
                                    borderRadius: '10px',
                                    fontSize: '1rem',
                                    outline: 'none'
                                }}
                            />
                            <div style={{ fontSize: '0.85rem', color: '#666', marginTop: '0.25rem' }}>
                                ÌïòÎ£®Ïóê ÌèâÍ∑†Ï†ÅÏúºÎ°ú Î™á Í∂åÏùò Ï±ÖÏùÑ ÏùΩÎäîÏßÄ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî
                            </div>
                        </div>

                        {/* Í∞êÏ†ï ÏòàÎØºÎèÑ */}
                        <div style={{ marginBottom: '1.5rem' }}>
                            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>
                                Í∞êÏ†ï ÏòàÎØºÎèÑ
                            </label>
                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                {['ÎÜíÏùå', 'Î≥¥ÌÜµ', 'ÎÇÆÏùå'].map(level => (
                                    <button
                                        key={level}
                                        onClick={() => setEmotionSensitivity(level)}
                                        style={{
                                            flex: 1,
                                            padding: '0.75rem',
                                            border: emotionSensitivity === level ? '3px solid #FF69B4' : '2px solid #ddd',
                                            borderRadius: '10px',
                                            background: emotionSensitivity === level ? '#FFE4E1' : 'white',
                                            cursor: 'pointer',
                                            fontSize: '0.9rem'
                                        }}
                                    >
                                        {level === 'ÎÜíÏùå' ? 'üò∞ ÎÜíÏùå' : level === 'Î≥¥ÌÜµ' ? 'üòä Î≥¥ÌÜµ' : 'üòé ÎÇÆÏùå'}
                                    </button>
                                ))}
                            </div>
                            <div style={{ fontSize: '0.85rem', color: '#666', marginTop: '0.25rem' }}>
                                Í∞àÎì±Ïù¥ÎÇò Î¨¥ÏÑúÏö¥ Ïû•Î©¥Ïóê ÎØºÍ∞êÌïú Ï†ïÎèÑ (ÎÜíÏùå: Í∞àÎì± Ïû•Î©¥ÏùÑ ÌîºÌï¥Ïïº Ìï®, ÎÇÆÏùå: Îã§ÏñëÌïú ÎÇ¥Ïö©ÏùÑ Ïûò Î∞õÏïÑÎì§ÏûÑ)
                            </div>
                        </div>

                    {/* Ï†ÄÏû• Î≤ÑÌäº */}
                    <button
                        onClick={handleSave}
                        disabled={saving}
                        style={{
                            padding: '0.75rem 2rem',
                            background: saving ? '#ccc' : '#FF69B4',
                            border: 'none',
                            borderRadius: '10px',
                            color: 'white',
                            fontSize: '1rem',
                            fontWeight: 'bold',
                            cursor: saving ? 'not-allowed' : 'pointer',
                            marginTop: '1rem'
                        }}
                    >
                        {saving ? 'Ï†ÄÏû• Ï§ë...' : 'Ï†ÄÏû•ÌïòÍ∏∞'}
                    </button>
                </div>
            );
        }

        function AladinBookModal({ book, onClose, onAdd, onAddToInterested }) {
            const [adding, setAdding] = useState(false);
            const [addingToInterested, setAddingToInterested] = useState(false);

            const handleAdd = async () => {
                setAdding(true);
                await onAdd();
                setAdding(false);
            };

            const handleAddToInterested = async () => {
                setAddingToInterested(true);
                await onAddToInterested();
                setAddingToInterested(false);
            };

            return (
                <div onClick={onClose} style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: '1rem'
                }}>
                    <div onClick={(e) => e.stopPropagation()} style={{
                        background: 'white',
                        borderRadius: '20px',
                        padding: '2rem',
                        maxWidth: '600px',
                        width: '100%',
                        maxHeight: '90vh',
                        overflow: 'auto'
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '1.5rem' }}>
                            <h2 style={{ fontSize: '1.8rem', color: '#FF69B4', margin: 0 }}>
                                üìò Ïã†Í∞Ñ ÎèÑÏÑú
                            </h2>
                            <button
                                onClick={onClose}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    fontSize: '1.5rem',
                                    cursor: 'pointer',
                                    color: '#999',
                                    padding: '0.5rem'
                                }}
                            >
                                ‚úï
                            </button>
                        </div>

                        <div style={{ display: 'flex', gap: '1.5rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                            {book.cover && (
                                <img 
                                    src={book.cover} 
                                    alt={book.title}
                                    style={{
                                        width: '200px',
                                        height: '280px',
                                        objectFit: 'cover',
                                        borderRadius: '10px',
                                        boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                                    }}
                                />
                            )}
                            <div style={{ flex: 1, minWidth: '250px' }}>
                                <h3 style={{ fontSize: '1.5rem', color: '#333', marginBottom: '0.5rem' }}>
                                    {book.title}
                                </h3>
                                <p style={{ fontSize: '1rem', color: '#666', marginBottom: '0.25rem' }}>
                                    {book.author}
                                </p>
                                <p style={{ fontSize: '0.9rem', color: '#999', marginBottom: '1rem' }}>
                                    {book.publisher} ¬∑ {book.pubDate ? book.pubDate.substring(0, 4) : ''}ÎÖÑ
                                </p>
                                {book.rating > 0 && (
                                    <div style={{ marginBottom: '1rem' }}>
                                        <span style={{ 
                                            background: '#FFE4E1', 
                                            color: '#FF69B4', 
                                            padding: '0.25rem 0.75rem', 
                                            borderRadius: '20px',
                                            fontSize: '0.85rem',
                                            fontWeight: 'bold'
                                        }}>
                                            ‚≠ê {book.rating}/10
                                        </span>
                                    </div>
                                )}
                                {book.recommendationReason && (
                                    <div style={{
                                        marginTop: '1rem',
                                        padding: '1rem',
                                        background: 'linear-gradient(135deg, #FFF5E6 0%, #FFE4E1 100%)',
                                        borderRadius: '10px',
                                        border: '1px solid #FFB6C1',
                                        fontSize: '0.9rem',
                                        lineHeight: '1.6'
                                    }}>
                                        <div style={{
                                            fontSize: '0.75rem',
                                            color: '#FF69B4',
                                            fontWeight: 'bold',
                                            marginBottom: '0.5rem'
                                        }}>
                                            üíù Ïö∞Î¶¨ÏïÑÏù¥ÏóêÍ≤å Ï∂îÏ≤úÌïòÎäî Ïù¥Ïú†
                                        </div>
                                        <div>{book.recommendationReason}</div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {book.description && (
                            <div style={{
                                marginBottom: '1.5rem',
                                padding: '1rem',
                                background: '#F8F9FA',
                                borderRadius: '10px',
                                lineHeight: '1.6',
                                fontSize: '0.9rem',
                                color: '#333'
                            }}>
                                <strong style={{ display: 'block', marginBottom: '0.5rem', color: '#FF69B4' }}>
                                    üìñ Ï±Ö ÏÜåÍ∞ú
                                </strong>
                                <div style={{ whiteSpace: 'pre-wrap' }}>
                                    {book.description}
                                </div>
                            </div>
                        )}

                        <div style={{ display: 'flex', gap: '1rem', flexDirection: 'column' }}>
                            <div style={{ display: 'flex', gap: '1rem' }}>
                                <button
                                    onClick={handleAdd}
                                    disabled={adding}
                                    style={{
                                        flex: 1,
                                        padding: '0.75rem',
                                        background: adding ? '#ccc' : '#98D8C8',
                                        border: 'none',
                                        borderRadius: '10px',
                                        color: 'white',
                                        fontSize: '1rem',
                                        fontWeight: 'bold',
                                        cursor: adding ? 'not-allowed' : 'pointer'
                                    }}
                                >
                                    {adding ? '‚è≥ Ï∂îÍ∞Ä Ï§ë...' : '‚ûï Ï±Ö Ï∂îÍ∞ÄÌïòÍ∏∞'}
                                </button>
                            </div>
                            <button
                                onClick={handleAddToInterested}
                                disabled={addingToInterested}
                                style={{
                                    width: '100%',
                                    padding: '0.75rem',
                                    background: addingToInterested ? '#ccc' : '#DDA0DD',
                                    border: 'none',
                                    borderRadius: '10px',
                                    color: 'white',
                                    fontSize: '1rem',
                                    fontWeight: 'bold',
                                    cursor: addingToInterested ? 'not-allowed' : 'pointer'
                                }}
                            >
                                {addingToInterested ? '‚è≥ Ï∂îÍ∞Ä Ï§ë...' : 'üí° Í¥ÄÏã¨Ï±ÖÏúºÎ°ú Ï∂îÍ∞ÄÌïòÍ∏∞'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
